---
title: å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰
subtitle:
date: 2025-03-24T15:27:12+08:00
slug: 80f2e62
draft: false
categories: [æ‰¾å·¥ä½œ]
tags: [C++]
author:
  name: "yitao"
---

[ã€Šç°ä»£C++å¹¶å‘ç¼–ç¨‹æ•™ç¨‹ã€‹](https://mq-b.github.io/ModernCpp-ConcurrentProgramming-Tutorial/) â€”â€” C++å¹¶å‘ç¼–ç¨‹å­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰

<!--more-->

## åŸå­æ“ä½œ

```cpp
int a = 0;
void f() {
    ++a;
}
```

æ˜¾ç„¶ï¼Œ`++a` æ˜¯éåŸå­æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å¤šçº¿ç¨‹ä¸­å¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿåˆ°åªå®Œæˆä¸€åŠã€‚

å¯ä»¥ç”¨äº’æ–¥é‡æ¥ä¿æŠ¤å…±äº«èµ„æºï¼š

```cpp
std::mutex m;
void f() {
    std::lock_guard<std::mutex> lc{ m };
    ++a;
}
```

é€šè¿‡äº’æ–¥é‡çš„ä¿æŠ¤ï¼Œå³ä½¿ `++a` æœ¬èº«ä¸æ˜¯åŸå­æ“ä½œï¼Œé€»è¾‘ä¸Šä¹Ÿå¯è§†ä¸ºåŸå­æ“ä½œã€‚äº’æ–¥é‡ç¡®ä¿äº†å¯¹å…±äº«èµ„æºçš„è¯»å†™æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé¿å…äº†æ•°æ®ç«äº‰é—®é¢˜ã€‚

ä¸è¿‡è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ã€‚æˆ‘ä»¬æƒ³è¦çš„æ˜¯ä¸€ç§åŸå­ç±»å‹ï¼Œå®ƒçš„æ‰€æœ‰æ“ä½œéƒ½ç›´æ¥æ˜¯åŸå­çš„ï¼Œä¸éœ€è¦é¢å¤–çš„åŒæ­¥è®¾æ–½è¿›è¡Œä¿æŠ¤ã€‚C++11 å¼•å…¥äº†åŸå­ç±»å‹ std::atomicã€‚

## åŸå­ç±»å‹

è¿™é‡Œåªç®€å•ä»‹ç» `std::atomic<bool>`ï¼ˆåŒ…å«åœ¨ `<atomic>` ä¸­ï¼‰ï¼Œæœ€åŸºæœ¬çš„æ•´æ•°åŸå­ç±»å‹ã€‚è™½ç„¶åŒæ ·ä¸å¯å¤åˆ¶ä¸å¯ç§»åŠ¨ï¼Œä½†å¯ä»¥ä½¿ç”¨éåŸå­çš„ `bool` ç±»å‹è¿›è¡Œæ„é€ ï¼Œåˆå§‹åŒ–ä¸º `true` æˆ– `false`ï¼Œå¹¶ä¸”èƒ½ä»éåŸå­çš„ `bool` å¯¹è±¡èµ‹å€¼ç»™ `std::atomic<bool>`ï¼š
```cpp
std::atomic<bool> b{ true };
b = false;
```

è¿™äº›ç±»å‹çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œè¯­è¨€å®šä¹‰ä¸­åªæœ‰è¿™äº›ç±»å‹çš„æ“ä½œæ˜¯åŸå­çš„ï¼Œè™½ç„¶ä¹Ÿå¯ä»¥ç”¨äº’æ–¥é‡æ¥æ¨¡æ‹ŸåŸå­æ“ä½œã€‚

## çº¿ç¨‹æ± 

æŠ½è±¡çš„æ¥è¯´ï¼Œå¯ä»¥å½“åšæ˜¯ä¸€ä¸ªæ± å­ä¸­å­˜æ”¾äº†ä¸€å †çº¿ç¨‹ï¼Œæ•…ç§°ä½œ**çº¿ç¨‹æ± **ã€‚ç®€è€Œè¨€ä¹‹ï¼Œçº¿ç¨‹æ± æ˜¯æŒ‡ä»£ä¸€ç»„**é¢„å…ˆåˆ›å»ºçš„ã€å¯ä»¥å¤ç”¨çš„çº¿ç¨‹é›†åˆ**ã€‚è¿™äº›çº¿ç¨‹ç”±çº¿ç¨‹æ± ç®¡ç†ï¼Œç”¨äºæ‰§è¡Œå¤šä¸ªä»»åŠ¡è€Œ**æ— éœ€é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯**çº¿ç¨‹ã€‚

![Image](https://cdn.ipfsscan.io/weibo/large/005wRZF3ly1i4du48dgiwj30sv0f1wgg.jpg)

> è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„çº¿ç¨‹æ± ç»“æ„ã€‚çº¿ç¨‹æ± åŒ…å«ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œå½“æœ‰æ–°ä»»åŠ¡åŠ å…¥æ—¶ï¼Œè°ƒåº¦å™¨ä¼šå°†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹è¿›è¡Œæ‰§è¡Œã€‚çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„ä¸‹ä¸€æ¬¡å”¤é†’ã€‚å½“æœ‰æ–°çš„ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶ä¸”æœ‰çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€æ—¶ï¼Œè°ƒåº¦å™¨ä¼šå”¤é†’ä¼‘çœ çš„çº¿ç¨‹ï¼Œå¹¶åˆ†é…æ–°çš„ä»»åŠ¡ç»™å®ƒä»¬æ‰§è¡Œã€‚çº¿ç¨‹æ‰§è¡Œå®Œæ–°ä»»åŠ¡åï¼Œä¼šå†æ¬¡è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ–°çš„ä»»åŠ¡åˆ°æ¥ï¼Œè°ƒåº¦å™¨æ‰å¯èƒ½ä¼šå†æ¬¡å”¤é†’å®ƒä»¬ã€‚
å›¾ä¸­çº¿ç¨‹1 å°±æ˜¯è¢«è°ƒåº¦å™¨åˆ†é…äº†ä»»åŠ¡1ï¼Œæ‰§è¡Œå®Œæ¯•åä¼‘çœ ï¼Œç„¶è€Œæ–°ä»»åŠ¡çš„åˆ°æ¥è®©è°ƒåº¦å™¨å†æ¬¡å°†å®ƒå”¤é†’ï¼Œå»æ‰§è¡Œä»»åŠ¡6ï¼Œæ‰§è¡Œå®Œæ¯•åç»§ç»­ä¼‘çœ ã€‚

ä½¿ç”¨çº¿ç¨‹æ± çš„ç›Šå¤„æˆ‘ä»¬å·²ç»åŠ ç²—äº†ï¼Œç„¶è€Œè¿™å…¶å®å¹¶ä¸æ˜¯â€œçº¿ç¨‹æ± â€ç‹¬æœ‰çš„ï¼Œä»»ä½•åˆ›å»ºå’Œé”€æ¯å­˜åœ¨è¾ƒå¤§å¼€é”€çš„è®¾æ–½ï¼Œéƒ½å¯ä»¥è¿›è¡Œæ‰€è°“çš„â€œæ± åŒ–â€ã€‚

å¸¸è§çš„è¿˜æœ‰ï¼š==å¥—æ¥å­—è¿æ¥æ± ã€æ•°æ®åº“è¿æ¥æ± ã€å†…å­˜æ± ã€å¯¹è±¡æ± ==ã€‚

ä¸‹é¢ç®€å•ä»‹ç»ä¸‹å¸¸ç”¨çš„çº¿ç¨‹æ± ã€‚

### `boost::asio::thread_pool`

`boost::asio::thread_pool` æ˜¯ `Boost.Asio` åº“æä¾›çš„ä¸€ç§çº¿ç¨‹æ± å®ç°ã€‚
> Asio æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ C++ åº“ï¼Œç”¨äºç½‘ç»œå’Œä½çº§ I/O ç¼–ç¨‹ï¼Œä½¿ç”¨ ç°ä»£C++ æ–¹æ³•ä¸ºå¼€å‘äººå‘˜æä¾›ä¸€è‡´çš„å¼‚æ­¥æ¨¡å‹ã€‚

ä½¿ç”¨æ–¹æ³•ï¼š
1. åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡ï¼ŒæŒ‡å®šæˆ–è®© Asio è‡ªåŠ¨å†³å®šçº¿ç¨‹æ•°é‡ã€‚
2. æäº¤ä»»åŠ¡ï¼šé€šè¿‡ `boost::asio::post` å‡½æ•°æ¨¡æ¿æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ã€‚
3. é˜»å¡ï¼Œç›´åˆ°æ± ä¸­çš„çº¿ç¨‹å®Œæˆä»»åŠ¡ã€‚

```cpp
#include <boost/asio.hpp>
#include <iostream>

std::mutex m;

void print_task(int n) {
    std::lock_guard<std::mutex> lc{ m };
    std::cout << "Task " << n << " is running on thr: " <<
        std::this_thread::get_id() << '\n';
}

int main() {
    boost::asio::thread_pool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªåŒ…å« 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 

    for (int i = 0; i < 10; ++i) {
        boost::asio::post(pool, [i] { print_task(i); });
    }

    pool.join(); // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆ
}
```

è¯¦æƒ…è§ `boost/asio` çš„ä½¿ç”¨ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚

### å®ç°çº¿ç¨‹æ± 

å®ç°ä¸€ä¸ªæ™®é€šçš„èƒ½å¤Ÿæ»¡è¶³æ—¥å¸¸å¼€å‘éœ€æ±‚çš„çº¿ç¨‹æ± å®é™…ä¸Šéå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸åˆ°ä¸€ç™¾è¡Œä»£ç ã€‚å…¶å®ç»å¤§éƒ¨åˆ†å¼€å‘è€…ä½¿ç”¨çº¿ç¨‹æ± ï¼Œåªæ˜¯ä¸ºäº†ä¸é‡å¤å¤šæ¬¡åˆ›å»ºçº¿ç¨‹ç½¢äº†ã€‚æ‰€ä»¥åªéœ€è¦ä¸€ä¸ªæä¾›ä¸€ä¸ªå¤–éƒ¨æ¥å£ï¼Œå¯ä»¥ä¼ å…¥ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åå®‰æ’çº¿ç¨‹å»æ‰§è¡Œã€‚æ— éæ˜¯ä½¿ç”¨æ¡ä»¶å˜é‡ã€äº’æ–¥é‡ã€åŸå­æ ‡å¿—ä½ï¼Œè¿™äº›ä¸œè¥¿ï¼Œå°±è¶³å¤Ÿç¼–å†™ä¸€ä¸ªæ»¡è¶³ç»å¤§éƒ¨åˆ†ä¸šåŠ¡éœ€æ±‚çš„çº¿ç¨‹æ± ã€‚

æˆ‘ä»¬å…ˆç¼–å†™ä¸€ä¸ªæœ€åŸºç¡€çš„çº¿ç¨‹æ± ï¼Œé¦–å…ˆç¡®å®šå®ƒçš„æ•°æ®æˆå‘˜ï¼š

```cpp
class ThreadPool {
    std::mutex                mutex_;           // ç”¨äºä¿æŠ¤å…±äº«èµ„æºï¼ˆå¦‚ä»»åŠ¡é˜Ÿåˆ—ï¼‰åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„è®¿é—®ï¼Œé¿å…æ•°æ®ç«äº‰ã€‚
    std::condition_variable   cv_;              // ç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå…è®¸çº¿ç¨‹ç­‰å¾…ç‰¹å®šæ¡ä»¶ï¼ˆå¦‚æ–°ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼‰å¹¶åœ¨æ¡ä»¶æ»¡è¶³æ—¶å”¤é†’çº¿ç¨‹ã€‚
    std::atomic<bool>         stop_;            // æŒ‡ç¤ºçº¿ç¨‹æ± æ˜¯å¦åœæ­¢ã€‚
    std::atomic<std::size_t>  num_threads_;     // è¡¨ç¤ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ã€‚
    std::queue<Task>          tasks_;           // ä»»åŠ¡é˜Ÿåˆ—ï¼Œå­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä»»åŠ¡æŒ‰æäº¤é¡ºåºæ‰§è¡Œã€‚
    std::vector<std::thread>  pool_;            // çº¿ç¨‹å®¹å™¨ï¼Œå­˜å‚¨ç®¡ç†çº¿ç¨‹å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚
};
```

æ ‡å¤´ä¾èµ–ï¼š
```cpp
#include <iostream>
#include <thread>
#include <mutex>
#include <condition_variable>
#include <future>
#include <atomic>
#include <queue>
#include <vector>
#include <syncstream>
#include <functional>
```

æä¾›æ„é€ ææ„å‡½æ•°ï¼Œä»¥åŠä¸€äº›å¤–éƒ¨æ¥å£ï¼š`submit()`ã€`start()`ã€`stop()`ã€`join()`ï¼Œä¹Ÿå°±å®Œæˆäº†ï¼š

```cpp
inline std::size_t default_thread_pool_size()noexcept {
    std::size_t num_threads = std::thread::hardware_concurrency() * 2;
    num_threads = num_threads == 0 ? 2 : num_threads;
    return num_threads;
}

class ThreadPool {
private:
    std::mutex                mutex_;
    std::condition_variable   cv_;
    std::atomic<bool>         stop_;
    std::atomic<std::size_t>  num_threads_;
    std::queue<Task>          tasks_;
    std::vector<std::thread>  pool_;

public:
    using Task = std::packaged_task<void()>;

    ThreadPool(const ThreadPool&) = delete;
    ThreadPool& operator=(const ThreadPool&) = delete;

    ThreadPool(std::size_t num_thread = default_thread_pool_size())
        : stop_{ false }, num_threads_{ num_thread } {
        start();
    }

    ~ThreadPool() {
        stop();
    }

    void stop() {
        stop_.store(true);
        cv_.notify_all();
        for (auto& thread : pool_) {
            if (thread.joinable()) {
                thread.join();
            }
        }
        pool_.clear();
    }

    template<typename F, typename... Args>
    std::future<std::invoke_result_t<std::decay_t<F>, std::decay_t<Args>...>> submit(F&& f, Args&&...args) {
        using RetType = std::invoke_result_t<std::decay_t<F>, std::decay_t<Args>...>;
        if (stop_.load()) {
            throw std::runtime_error("ThreadPool is stopped");
        }

        auto task = std::make_shared<std::packaged_task<RetType()>>(
            std::bind(std::forward<F>(f), std::forward<Args>(args)...));
        std::future<RetType> ret = task->get_future();

        {
            std::lock_guard<std::mutex> lc{ mutex_ };
            tasks_.emplace([task] {(*task)(); });
        }
        cv_.notify_one();
        return ret;
    }

    void start() {
        for (std::size_t i = 0; i < num_threads_; ++i) {
            pool_.emplace_back([this] {
                while (!stop_) {
                    Task task;
                    {
                        std::unique_lock<std::mutex> lc{ mutex_ };
                        cv_.wait(lc, [this] {return stop_ || !tasks_.empty(); });
                        if (tasks_.empty())
                            return;
                        task = std::move(tasks_.front());
                        tasks_.pop();
                    }
                    task();
                }
            });
        }
    }
};
```

æµ‹è¯• demo:

```cpp
int main() {
    ThreadPool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªæœ‰ 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
    std::vector<std::future<int>> futures; // future é›†åˆï¼Œè·å–è¿”å›å€¼

    for (int i = 0; i < 10; ++i) {
        futures.emplace_back(pool.submit(print_task, i));
    }

    for (int i = 0; i < 10; ++i) {
        futures.emplace_back(pool.submit(print_task2, i));
    }

    int sum = 0;
    for (auto& future : futures) {
        sum += future.get(); // get() æˆå‘˜å‡½æ•° é˜»å¡åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè·å–è¿”å›å€¼
    }
    std::cout << "sum: " << sum << '\n';
} // ææ„è‡ªåŠ¨ stop()
```

å¯èƒ½çš„è¿è¡Œç»“æœï¼š

```cpp
Task 0 is running on thr: 6900
Task 1 is running on thr: 36304
Task 5 is running on thr: 36304
Task 3 is running on thr: 6900
Task 7 is running on thr: 6900
Task 2 is running on thr: 29376
Task 6 is running on thr: 36304
Task 4 is running on thr: 31416
ğŸ¢ğŸ¢ğŸ¢ 1 ğŸ‰ğŸ‰ğŸ‰
Task 9 is running on thr: 29376
ğŸ¢ğŸ¢ğŸ¢ 0 ğŸ‰ğŸ‰ğŸ‰
Task 8 is running on thr: 6900
ğŸ¢ğŸ¢ğŸ¢ 2 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 6 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 4 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 5 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 3 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 7 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 8 ğŸ‰ğŸ‰ğŸ‰
ğŸ¢ğŸ¢ğŸ¢ 9 ğŸ‰ğŸ‰ğŸ‰
sum: 90
```

å®ƒæ”¯æŒä»»æ„å¯è°ƒç”¨ç±»å‹ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬éé™æ€æˆå‘˜å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨äº† `std::decay_t`ï¼Œæ‰€ä»¥å‚æ•°çš„ä¼ é€’å…¶å®æ˜¯æŒ‰å€¼å¤åˆ¶ï¼Œè€Œä¸æ˜¯å¼•ç”¨ä¼ é€’ï¼Œè¿™ä¸€ç‚¹å’Œå¤§éƒ¨åˆ†åº“çš„è®¾è®¡ä¸€è‡´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

```cpp
struct X {
    void f(const int& n) const {
        std::osyncstream{ std::cout } << &n << '\n';
    }
};

int main() {
    ThreadPool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªæœ‰ 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 

    X x;
    int n = 6;
    std::cout << &n << '\n';
    auto t = pool.submit(&X::f, &x, n); // é»˜è®¤å¤åˆ¶ï¼Œåœ°å€ä¸åŒ
    auto t2 = pool.submit(&X::f, &x, std::ref(n));
    t.wait();
    t2.wait();
} // ææ„è‡ªåŠ¨ stop()
```

æˆ‘ä»¬çš„çº¿ç¨‹æ± çš„ `submit` æˆå‘˜å‡½æ•°åœ¨ä¼ é€’å‚æ•°çš„è¡Œä¸ºä¸Šï¼Œä¸å…ˆå‰ä»‹ç»çš„ `std::thread` å’Œ `std::async` ç­‰è®¾æ–½åŸºæœ¬ä¸€è‡´ã€‚

æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼š

- æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ–çº¿ç¨‹æ± å¹¶**å¯åŠ¨çº¿ç¨‹**ã€‚
- ææ„å‡½æ•°ï¼šåœæ­¢çº¿ç¨‹æ± å¹¶ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸã€‚

å¤–éƒ¨æ¥å£ï¼š

- `stop()`ï¼šåœæ­¢çº¿ç¨‹æ± ï¼Œé€šçŸ¥æ‰€æœ‰çº¿ç¨‹é€€å‡ºï¼ˆä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼‰ã€‚
- `submit()`ï¼šå°†ä»»åŠ¡æäº¤åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹¶è¿”å›ä¸€ä¸ª `std::future` å¯¹è±¡ç”¨äºè·å–ä»»åŠ¡ç»“æœä»¥åŠç¡®ä¿ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚
- `start()`ï¼šå¯åŠ¨çº¿ç¨‹æ± ï¼Œåˆ›å»ºå¹¶å¯åŠ¨æŒ‡å®šæ•°é‡çš„çº¿ç¨‹ã€‚
