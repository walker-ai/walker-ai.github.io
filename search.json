[{"categories":["å…«è‚¡"],"content":"ã€Šç°ä»£C++å¹¶å‘ç¼–ç¨‹æ•™ç¨‹ã€‹ â€”â€” C++å¹¶å‘ç¼–ç¨‹å­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰ ","date":"2025-03-24","objectID":"/2025/80f2e62/:0:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰","uri":"/2025/80f2e62/"},{"categories":["å…«è‚¡"],"content":"åŸå­æ“ä½œ è¿™é‡Œåªç®€å•ä»‹ç» std::atomic\u003cbool\u003eï¼ˆåŒ…å«åœ¨ \u003catomic\u003e ä¸­ï¼‰ï¼Œæœ€åŸºæœ¬çš„æ•´æ•°åŸå­ç±»å‹ã€‚è™½ç„¶åŒæ ·ä¸å¯å¤åˆ¶ä¸å¯ç§»åŠ¨ï¼Œä½†å¯ä»¥ä½¿ç”¨éåŸå­çš„ bool ç±»å‹è¿›è¡Œæ„é€ ï¼Œåˆå§‹åŒ–ä¸º true æˆ– falseï¼Œå¹¶ä¸”èƒ½ä»éåŸå­çš„ bool å¯¹è±¡èµ‹å€¼ç»™ std::atomic\u003cbool\u003eï¼š std::atomic\u003cbool\u003e b{ true }; b = false; ","date":"2025-03-24","objectID":"/2025/80f2e62/:1:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰","uri":"/2025/80f2e62/"},{"categories":["å…«è‚¡"],"content":"çº¿ç¨‹æ±  æŠ½è±¡çš„æ¥è¯´ï¼Œå¯ä»¥å½“åšæ˜¯ä¸€ä¸ªæ± å­ä¸­å­˜æ”¾äº†ä¸€å †çº¿ç¨‹ï¼Œæ•…ç§°ä½œçº¿ç¨‹æ± ã€‚ç®€è€Œè¨€ä¹‹ï¼Œçº¿ç¨‹æ± æ˜¯æŒ‡ä»£ä¸€ç»„é¢„å…ˆåˆ›å»ºçš„ã€å¯ä»¥å¤ç”¨çš„çº¿ç¨‹é›†åˆã€‚è¿™äº›çº¿ç¨‹ç”±çº¿ç¨‹æ± ç®¡ç†ï¼Œç”¨äºæ‰§è¡Œå¤šä¸ªä»»åŠ¡è€Œæ— éœ€é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ã€‚ è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„çº¿ç¨‹æ± ç»“æ„ã€‚çº¿ç¨‹æ± åŒ…å«ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œå½“æœ‰æ–°ä»»åŠ¡åŠ å…¥æ—¶ï¼Œè°ƒåº¦å™¨ä¼šå°†ä»»åŠ¡åˆ†é…ç»™çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹è¿›è¡Œæ‰§è¡Œã€‚çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„ä¸‹ä¸€æ¬¡å”¤é†’ã€‚å½“æœ‰æ–°çš„ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶ä¸”æœ‰çº¿ç¨‹å¤„äºä¼‘çœ çŠ¶æ€æ—¶ï¼Œè°ƒåº¦å™¨ä¼šå”¤é†’ä¼‘çœ çš„çº¿ç¨‹ï¼Œå¹¶åˆ†é…æ–°çš„ä»»åŠ¡ç»™å®ƒä»¬æ‰§è¡Œã€‚çº¿ç¨‹æ‰§è¡Œå®Œæ–°ä»»åŠ¡åï¼Œä¼šå†æ¬¡è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ–°çš„ä»»åŠ¡åˆ°æ¥ï¼Œè°ƒåº¦å™¨æ‰å¯èƒ½ä¼šå†æ¬¡å”¤é†’å®ƒä»¬ã€‚ å›¾ä¸­çº¿ç¨‹1 å°±æ˜¯è¢«è°ƒåº¦å™¨åˆ†é…äº†ä»»åŠ¡1ï¼Œæ‰§è¡Œå®Œæ¯•åä¼‘çœ ï¼Œç„¶è€Œæ–°ä»»åŠ¡çš„åˆ°æ¥è®©è°ƒåº¦å™¨å†æ¬¡å°†å®ƒå”¤é†’ï¼Œå»æ‰§è¡Œä»»åŠ¡6ï¼Œæ‰§è¡Œå®Œæ¯•åç»§ç»­ä¼‘çœ ã€‚ ä½¿ç”¨çº¿ç¨‹æ± çš„ç›Šå¤„æˆ‘ä»¬å·²ç»åŠ ç²—äº†ï¼Œç„¶è€Œè¿™å…¶å®å¹¶ä¸æ˜¯â€œçº¿ç¨‹æ± â€ç‹¬æœ‰çš„ï¼Œä»»ä½•åˆ›å»ºå’Œé”€æ¯å­˜åœ¨è¾ƒå¤§å¼€é”€çš„è®¾æ–½ï¼Œéƒ½å¯ä»¥è¿›è¡Œæ‰€è°“çš„â€œæ± åŒ–â€ã€‚ å¸¸è§çš„è¿˜æœ‰ï¼šå¥—æ¥å­—è¿æ¥æ± ã€æ•°æ®åº“è¿æ¥æ± ã€å†…å­˜æ± ã€å¯¹è±¡æ± ã€‚ ä¸‹é¢ç®€å•ä»‹ç»ä¸‹å¸¸ç”¨çš„çº¿ç¨‹æ± ã€‚ ","date":"2025-03-24","objectID":"/2025/80f2e62/:2:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰","uri":"/2025/80f2e62/"},{"categories":["å…«è‚¡"],"content":"boost::asio::thread_pool boost::asio::thread_pool æ˜¯ Boost.Asio åº“æä¾›çš„ä¸€ç§çº¿ç¨‹æ± å®ç°ã€‚ Asio æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ C++ åº“ï¼Œç”¨äºç½‘ç»œå’Œä½çº§ I/O ç¼–ç¨‹ï¼Œä½¿ç”¨ ç°ä»£C++ æ–¹æ³•ä¸ºå¼€å‘äººå‘˜æä¾›ä¸€è‡´çš„å¼‚æ­¥æ¨¡å‹ã€‚ ä½¿ç”¨æ–¹æ³•ï¼š åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡ï¼ŒæŒ‡å®šæˆ–è®© Asio è‡ªåŠ¨å†³å®šçº¿ç¨‹æ•°é‡ã€‚ æäº¤ä»»åŠ¡ï¼šé€šè¿‡ boost::asio::post å‡½æ•°æ¨¡æ¿æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ã€‚ é˜»å¡ï¼Œç›´åˆ°æ± ä¸­çš„çº¿ç¨‹å®Œæˆä»»åŠ¡ã€‚ #include \u003cboost/asio.hpp\u003e #include \u003ciostream\u003e std::mutex m; void print_task(int n) { std::lock_guard\u003cstd::mutex\u003e lc{ m }; std::cout \u003c\u003c \"Task \" \u003c\u003c n \u003c\u003c \" is running on thr: \" \u003c\u003c std::this_thread::get_id() \u003c\u003c '\\n'; } int main() { boost::asio::thread_pool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªåŒ…å« 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ±  for (int i = 0; i \u003c 10; ++i) { boost::asio::post(pool, [i] { print_task(i); }); } pool.join(); // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆ } è¯¦æƒ…è§ boost/asio çš„ä½¿ç”¨ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚ ","date":"2025-03-24","objectID":"/2025/80f2e62/:2:1","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰","uri":"/2025/80f2e62/"},{"categories":["å…«è‚¡"],"content":"å®ç°çº¿ç¨‹æ±  å®ç°ä¸€ä¸ªæ™®é€šçš„èƒ½å¤Ÿæ»¡è¶³æ—¥å¸¸å¼€å‘éœ€æ±‚çš„çº¿ç¨‹æ± å®é™…ä¸Šéå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸åˆ°ä¸€ç™¾è¡Œä»£ç ã€‚å…¶å®ç»å¤§éƒ¨åˆ†å¼€å‘è€…ä½¿ç”¨çº¿ç¨‹æ± ï¼Œåªæ˜¯ä¸ºäº†ä¸é‡å¤å¤šæ¬¡åˆ›å»ºçº¿ç¨‹ç½¢äº†ã€‚æ‰€ä»¥åªéœ€è¦ä¸€ä¸ªæä¾›ä¸€ä¸ªå¤–éƒ¨æ¥å£ï¼Œå¯ä»¥ä¼ å…¥ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œç„¶åå®‰æ’çº¿ç¨‹å»æ‰§è¡Œã€‚æ— éæ˜¯ä½¿ç”¨æ¡ä»¶å˜é‡ã€äº’æ–¥é‡ã€åŸå­æ ‡å¿—ä½ï¼Œè¿™äº›ä¸œè¥¿ï¼Œå°±è¶³å¤Ÿç¼–å†™ä¸€ä¸ªæ»¡è¶³ç»å¤§éƒ¨åˆ†ä¸šåŠ¡éœ€æ±‚çš„çº¿ç¨‹æ± ã€‚ æˆ‘ä»¬å…ˆç¼–å†™ä¸€ä¸ªæœ€åŸºç¡€çš„çº¿ç¨‹æ± ï¼Œé¦–å…ˆç¡®å®šå®ƒçš„æ•°æ®æˆå‘˜ï¼š class ThreadPool { std::mutex mutex_; // ç”¨äºä¿æŠ¤å…±äº«èµ„æºï¼ˆå¦‚ä»»åŠ¡é˜Ÿåˆ—ï¼‰åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„è®¿é—®ï¼Œé¿å…æ•°æ®ç«äº‰ã€‚ std::condition_variable cv_; // ç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå…è®¸çº¿ç¨‹ç­‰å¾…ç‰¹å®šæ¡ä»¶ï¼ˆå¦‚æ–°ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼‰å¹¶åœ¨æ¡ä»¶æ»¡è¶³æ—¶å”¤é†’çº¿ç¨‹ã€‚ std::atomic\u003cbool\u003e stop_; // æŒ‡ç¤ºçº¿ç¨‹æ± æ˜¯å¦åœæ­¢ã€‚ std::atomic\u003cstd::size_t\u003e num_threads_; // è¡¨ç¤ºçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ã€‚ std::queue\u003cTask\u003e tasks_; // ä»»åŠ¡é˜Ÿåˆ—ï¼Œå­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä»»åŠ¡æŒ‰æäº¤é¡ºåºæ‰§è¡Œã€‚ std::vector\u003cstd::thread\u003e pool_; // çº¿ç¨‹å®¹å™¨ï¼Œå­˜å‚¨ç®¡ç†çº¿ç¨‹å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚ }; æ ‡å¤´ä¾èµ–ï¼š #include \u003ciostream\u003e #include \u003cthread\u003e #include \u003cmutex\u003e #include \u003ccondition_variable\u003e #include \u003cfuture\u003e #include \u003catomic\u003e #include \u003cqueue\u003e #include \u003cvector\u003e #include \u003csyncstream\u003e #include \u003cfunctional\u003e æä¾›æ„é€ ææ„å‡½æ•°ï¼Œä»¥åŠä¸€äº›å¤–éƒ¨æ¥å£ï¼šsubmit()ã€start()ã€stop()ã€join()ï¼Œä¹Ÿå°±å®Œæˆäº†ï¼š inline std::size_t default_thread_pool_size()noexcept { std::size_t num_threads = std::thread::hardware_concurrency() * 2; num_threads = num_threads == 0 ? 2 : num_threads; return num_threads; } class ThreadPool { public: using Task = std::packaged_task\u003cvoid()\u003e; ThreadPool(const ThreadPool\u0026) = delete; ThreadPool\u0026 operator=(const ThreadPool\u0026) = delete; ThreadPool(std::size_t num_thread = default_thread_pool_size()) : stop_{ false }, num_threads_{ num_thread } { start(); } ~ThreadPool() { stop(); } void stop() { stop_.store(true); cv_.notify_all(); for (auto\u0026 thread : pool_) { if (thread.joinable()) { thread.join(); } } pool_.clear(); } template\u003ctypename F, typename... Args\u003e std::future\u003cstd::invoke_result_t\u003cstd::decay_t\u003cF\u003e, std::decay_t\u003cArgs\u003e...\u003e\u003e submit(F\u0026\u0026 f, Args\u0026\u0026...args) { using RetType = std::invoke_result_t\u003cstd::decay_t\u003cF\u003e, std::decay_t\u003cArgs\u003e...\u003e; if (stop_.load()) { throw std::runtime_error(\"ThreadPool is stopped\"); } auto task = std::make_shared\u003cstd::packaged_task\u003cRetType()\u003e\u003e( std::bind(std::forward\u003cF\u003e(f), std::forward\u003cArgs\u003e(args)...)); std::future\u003cRetType\u003e ret = task-\u003eget_future(); { std::lock_guard\u003cstd::mutex\u003e lc{ mutex_ }; tasks_.emplace([task] {(*task)(); }); } cv_.notify_one(); return ret; } void start() { for (std::size_t i = 0; i \u003c num_threads_; ++i) { pool_.emplace_back([this] { while (!stop_) { Task task; { std::unique_lock\u003cstd::mutex\u003e lc{ mutex_ }; cv_.wait(lc, [this] {return stop_ || !tasks_.empty(); }); if (tasks_.empty()) return; task = std::move(tasks_.front()); tasks_.pop(); } task(); } }); } } private: std::mutex mutex_; std::condition_variable cv_; std::atomic\u003cbool\u003e stop_; std::atomic\u003cstd::size_t\u003e num_threads_; std::queue\u003cTask\u003e tasks_; std::vector\u003cstd::thread\u003e pool_; }; æµ‹è¯• demo: int main() { ThreadPool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªæœ‰ 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ±  std::vector\u003cstd::future\u003cint\u003e\u003e futures; // future é›†åˆï¼Œè·å–è¿”å›å€¼ for (int i = 0; i \u003c 10; ++i) { futures.emplace_back(pool.submit(print_task, i)); } for (int i = 0; i \u003c 10; ++i) { futures.emplace_back(pool.submit(print_task2, i)); } int sum = 0; for (auto\u0026 future : futures) { sum += future.get(); // get() æˆå‘˜å‡½æ•° é˜»å¡åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè·å–è¿”å›å€¼ } std::cout \u003c\u003c \"sum: \" \u003c\u003c sum \u003c\u003c '\\n'; } // ææ„è‡ªåŠ¨ stop() å¯èƒ½çš„è¿è¡Œç»“æœï¼š Task 0 is running on thr: 6900 Task 1 is running on thr: 36304 Task 5 is running on thr: 36304 Task 3 is running on thr: 6900 Task 7 is running on thr: 6900 Task 2 is running on thr: 29376 Task 6 is running on thr: 36304 Task 4 is running on thr: 31416 ğŸ¢ğŸ¢ğŸ¢ 1 ğŸ‰ğŸ‰ğŸ‰ Task 9 is running on thr: 29376 ğŸ¢ğŸ¢ğŸ¢ 0 ğŸ‰ğŸ‰ğŸ‰ Task 8 is running on thr: 6900 ğŸ¢ğŸ¢ğŸ¢ 2 ğŸ‰ğŸ‰ğŸ‰ ğŸ¢ğŸ¢ğŸ¢ 6 ğŸ‰ğŸ‰ğŸ‰ ğŸ¢ğŸ¢ğŸ¢ 4 ğŸ‰ğŸ‰ğŸ‰ ğŸ¢ğŸ¢ğŸ¢ 5 ğŸ‰ğŸ‰ğŸ‰ ğŸ¢ğŸ¢ğŸ¢ 3 ğŸ‰ğŸ‰ğŸ‰ ğŸ¢ğŸ¢ğŸ¢ 7 ğŸ‰ğŸ‰ğŸ‰ ğŸ¢ğŸ¢ğŸ¢ 8 ğŸ‰ğŸ‰ğŸ‰ ğŸ¢ğŸ¢ğŸ¢ 9 ğŸ‰ğŸ‰ğŸ‰ sum: 90 å®ƒæ”¯æŒä»»æ„å¯è°ƒç”¨ç±»å‹ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬éé™æ€æˆå‘˜å‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨äº† std::decay_tï¼Œæ‰€ä»¥å‚æ•°çš„ä¼ é€’å…¶å®æ˜¯æŒ‰å€¼å¤åˆ¶ï¼Œè€Œä¸æ˜¯å¼•ç”¨ä¼ é€’ï¼Œè¿™ä¸€ç‚¹å’Œå¤§éƒ¨åˆ†åº“çš„è®¾è®¡ä¸€è‡´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š struct X { void f(const int\u0026 n) const { std::osyncstream{ std::cout } \u003c\u003c \u0026n \u003c\u003c '\\n'; } }; int main() { ThreadPool pool{ 4 }; // åˆ›å»ºä¸€ä¸ªæœ‰ 4 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ±  X x; int n = 6; std::cout \u003c\u003c \u0026n \u003c\u003c '\\n'; auto t = pool.submit(\u0026X::f, \u0026x, n); // é»˜è®¤å¤åˆ¶ï¼Œåœ°å€ä¸åŒ auto t2 = pool.submit(\u0026X::f, \u0026x, std::ref(n)); t.wait(); t2.wait(); } // ææ„è‡ªåŠ¨ stop() æˆ‘ä»¬çš„çº¿ç¨‹æ± çš„ submit æˆå‘˜å‡½æ•°åœ¨ä¼ é€’å‚æ•°çš„è¡Œä¸ºä¸Šï¼Œä¸å…ˆå‰ä»‹ç»çš„ std::thread å’Œ std::async ç­‰è®¾æ–½åŸºæœ¬ä¸€è‡´ã€‚ æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼š æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ–çº¿ç¨‹æ± å¹¶å¯åŠ¨çº¿ç¨‹ã€‚ ææ„å‡½æ•°ï¼šåœæ­¢çº¿ç¨‹æ± å¹¶ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸã€‚ å¤–éƒ¨æ¥å£ï¼š stop()ï¼šåœæ­¢çº¿ç¨‹æ± ï¼Œé€šçŸ¥æ‰€æœ‰çº¿ç¨‹é€€å‡ºï¼ˆä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼‰ã€‚ submit()ï¼šå°†ä»»åŠ¡æäº¤åˆ°ä»»åŠ¡","date":"2025-03-24","objectID":"/2025/80f2e62/:2:2","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰","uri":"/2025/80f2e62/"},{"categories":["å…«è‚¡"],"content":"ã€Šç°ä»£C++å¹¶å‘ç¼–ç¨‹æ•™ç¨‹ã€‹ â€”â€” C++å¹¶å‘ç¼–ç¨‹å­¦ä¹ ç¬”è®°ï¼ˆäºŒï¼‰ ","date":"2025-03-24","objectID":"/2025/4b155bd/:0:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰","uri":"/2025/4b155bd/"},{"categories":["å…«è‚¡"],"content":"ç­‰å¾…äº‹ä»¶æˆ–æ¡ä»¶ å‡è®¾ä½ æ­£åœ¨ä¸€è¾†å¤œé—´è¿è¡Œçš„åœ°é“ä¸Šï¼Œé‚£ä¹ˆä½ è¦å¦‚ä½•åœ¨æ­£ç¡®çš„ç«™ç‚¹ä¸‹è½¦å‘¢ï¼Ÿ 1.ä¸€ç›´ä¸ä¼‘æ¯ï¼Œæ¯ä¸€ç«™éƒ½èƒ½çŸ¥é“ï¼Œè¿™æ ·å°±ä¸ä¼šé”™è¿‡ä½ è¦ä¸‹è½¦çš„ç«™ç‚¹ï¼Œä½†æ˜¯è¿™ä¼šå¾ˆç–²æƒ«ã€‚ è¿™ç§æ–¹æ³•è¢«ç§°ä¸ºâ€œå¿™ç­‰å¾…ï¼ˆbusy waitingï¼‰â€ä¹Ÿç§° â€œè‡ªæ—‹â€œã€‚ bool flag = false; std::mutex m; void wait_for_flag() { std::unique_lock\u003cstd::mutex\u003e lk{ m }; while (!flag){ lk.unlock(); // 1 è§£é”äº’æ–¥é‡ lk.lock(); // 2 ä¸Šé”äº’æ–¥é‡ } } 2.å¯ä»¥çœ‹ä¸€ä¸‹æ—¶é—´ï¼Œä¼°ç®—ä¸€ä¸‹åœ°é“åˆ°è¾¾ç›®çš„åœ°çš„æ—¶é—´ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªç¨æ—©çš„é—¹é’Ÿï¼Œå°±ä¼‘æ¯ã€‚è¿™ä¸ªæ–¹æ³•å¬èµ·æ¥è¿˜è¡Œï¼Œä½†æ˜¯ä½ å¯èƒ½è¢«è¿‡æ—©çš„å«é†’ï¼Œç”šè‡³ä¼°ç®—é”™è¯¯å¯¼è‡´åè¿‡ç«™ï¼Œåˆæˆ–è€…é—¹é’Ÿæ²¡ç”µäº†ç¡è¿‡ç«™ã€‚ ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯åŠ ä¸ªå»¶æ—¶ï¼Œè¿™ç§å®ç°è¿›æ­¥äº†å¾ˆå¤šï¼Œå‡å°‘æµªè´¹çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å¾ˆéš¾ç¡®å®šæ­£ç¡®çš„ä¼‘çœ æ—¶é—´ã€‚è¿™ä¼šå½±å“åˆ°ç¨‹åºçš„è¡Œä¸ºï¼Œåœ¨éœ€è¦å¿«é€Ÿå“åº”çš„ç¨‹åºä¸­å°±æ„å‘³ç€ä¸¢å¸§æˆ–é”™è¿‡äº†ä¸€ä¸ªæ—¶é—´ç‰‡ã€‚å¾ªç¯ä¸­ï¼Œä¼‘çœ  â‘¡ å‰å‡½æ•°å¯¹äº’æ–¥é‡è§£é” â‘ ï¼Œå†ä¼‘çœ ç»“æŸåå†å¯¹äº’æ–¥é‡ä¸Šé”ï¼Œè®©å¦å¤–çš„çº¿ç¨‹æœ‰æœºä¼šè·å–é”å¹¶è®¾ç½®æ ‡è¯†ï¼ˆå› ä¸ºä¿®æ”¹å‡½æ•°å’Œç­‰å¾…å‡½æ•°å…±ç”¨ä¸€ä¸ªäº’æ–¥é‡ï¼‰ã€‚ void wait_for_flag() { std::unique_lock\u003cstd::mutex\u003e lk{ m }; while (!flag){ lk.unlock(); // 1 è§£é”äº’æ–¥é‡ std::this_thread::sleep_for(std::chrono::milliseconds(100)); // 2 ä¼‘çœ  lk.lock(); // 3 ä¸Šé”äº’æ–¥é‡ } } 3.äº‹å®ä¸Šæœ€ç®€å•çš„æ–¹å¼æ˜¯ï¼Œåˆ°ç«™çš„æ—¶å€™æœ‰äººæˆ–è€…å…¶å®ƒä¸œè¥¿èƒ½å°†ä½ å«é†’ï¼ˆæ¯”å¦‚æ‰‹æœºçš„åœ°å›¾ï¼Œåˆ°è¾¾è®¾ç½®çš„ä½ç½®å°±æé†’ï¼‰ã€‚ ç¬¬ä¸‰ç§æ–¹å¼ï¼ˆä¹Ÿæ˜¯æœ€å¥½çš„ï¼‰å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨æ¡ä»¶å˜é‡äº†ã€‚é€šè¿‡å¦ä¸€çº¿ç¨‹è§¦å‘ç­‰å¾…äº‹ä»¶çš„æœºåˆ¶æ˜¯æœ€åŸºæœ¬çš„å”¤é†’æ–¹å¼ï¼Œè¿™ç§æœºåˆ¶å°±ç§°ä¸ºâ€œæ¡ä»¶å˜é‡â€ã€‚ C++ æ ‡å‡†åº“å¯¹æ¡ä»¶å˜é‡æœ‰ä¸¤å¥—å®ç°ï¼šstd::condition_variable å’Œ std::condition_variable_anyï¼Œè¿™ä¸¤ä¸ªå®ç°éƒ½åŒ…å«åœ¨ \u003ccondition_variable\u003e è¿™ä¸ªå¤´æ–‡ä»¶ä¸­ã€‚ condition_variable_any ç±»æ˜¯ std::condition_variable çš„æ³›åŒ–ã€‚ç›¸å¯¹äºåªåœ¨ std::unique_lock\u003cstd::mutex\u003e ä¸Šå·¥ä½œçš„ std::condition_variableï¼Œcondition_variable_any èƒ½åœ¨ä»»ä½•æ»¡è¶³ å¯åŸºæœ¬é”å®š(BasicLockable) è¦æ±‚çš„é”ä¸Šå·¥ä½œï¼Œæ‰€ä»¥å¢åŠ äº† _any åç¼€ã€‚æ˜¾è€Œæ˜“è§ï¼Œè¿™ç§åŒºåˆ†å¿…ç„¶æ˜¯ any ç‰ˆæ›´åŠ é€šç”¨ä½†æ˜¯å´æœ‰æ›´å¤šçš„æ€§èƒ½å¼€é”€ã€‚æ‰€ä»¥é€šå¸¸é¦–é€‰ std::condition_variableã€‚æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œæ‰ä¼šè€ƒè™‘ std::condition_variable_anyã€‚ std::mutex mtx; // åˆ›å»ºäº†ä¸€ä¸ªäº’æ–¥é‡ï¼Œç”¨äºä¿æŠ¤å…±äº«æ•°æ®çš„è®¿é—®ï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®åŒæ­¥ã€‚ std::condition_variable cv; // åˆ›å»ºäº†ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹å¯ä»¥ç­‰å¾…ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³æ—¶è¢«å”¤é†’ã€‚ bool arrived = false; // è®¾ç½®äº†ä¸€ä¸ªæ ‡å¿—ä½ï¼Œè¡¨ç¤ºæ˜¯å¦åˆ°è¾¾ç›®çš„åœ°ã€‚ void wait_for_arrival() { std::unique_lock\u003cstd::mutex\u003e lck(mtx); // ä½¿ç”¨äº’æ–¥é‡åˆ›å»ºäº†ä¸€ä¸ªç‹¬å é”ã€‚ cv.wait(lck, []{ return arrived; }); // é˜»å¡å½“å‰çº¿ç¨‹ï¼Œé‡Šæ”¾ï¼ˆunlockï¼‰é”ï¼Œç›´åˆ°æ¡ä»¶è¢«æ»¡è¶³ã€‚ std::cout \u003c\u003c \"åˆ°è¾¾ç›®çš„åœ°ï¼Œå¯ä»¥ä¸‹è½¦äº†ï¼\" \u003c\u003c std::endl; } void simulate_arrival() { std::this_thread::sleep_for(std::chrono::seconds(5)); // æ¨¡æ‹Ÿåœ°é“åˆ°ç«™ï¼Œå‡è®¾5ç§’ååˆ°è¾¾ç›®çš„åœ° { std::lock_guard\u003cstd::mutex\u003e lck(mtx); arrived = true; // è®¾ç½®æ¡ä»¶å˜é‡ä¸º trueï¼Œè¡¨ç¤ºåˆ°è¾¾ç›®çš„åœ° } cv.notify_one(); // é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ } è¿™æ ·ï¼Œå½“ simulate_arrival å‡½æ•°æ‰§è¡Œåï¼Œarrived è¢«è®¾ç½®ä¸º trueï¼Œå¹¶ä¸”é€šè¿‡ cv.notify_one() å”¤é†’äº†ç­‰å¾…åœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹ï¼Œä»è€Œä½¿å¾— wait_for_arrival å‡½æ•°ä¸­çš„ç­‰å¾…ç»“æŸï¼Œå¯ä»¥æ‰§è¡Œåç»­çš„æ“ä½œï¼Œå³è¾“å‡ºæç¤ºä¿¡æ¯ã€‚ æ¡ä»¶å˜é‡çš„ wait æˆå‘˜å‡½æ•°æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä»¥ä¸Šä»£ç ä½¿ç”¨çš„å°±æ˜¯ç¬¬äºŒä¸ªç‰ˆæœ¬ï¼Œä¼ å…¥äº†ä¸€ä¸ªè°“è¯ã€‚ void wait(std::unique_lock\u003cstd::mutex\u003e\u0026 lock); // 1 template\u003cclass Predicate\u003e void wait(std::unique_lock\u003cstd::mutex\u003e\u0026 lock, Predicate pred); // 2 â‘¡ç­‰ä»·äºï¼š while (!pred()) wait(lock); ç¬¬äºŒä¸ªç‰ˆæœ¬åªæ˜¯å¯¹ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„åŒ…è£…ï¼Œç­‰å¾…å¹¶åˆ¤æ–­è°“è¯ï¼Œä¼šè°ƒç”¨ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„é‡è½½ã€‚è¿™å¯ä»¥é¿å… è™šå‡å”¤é†’ æ¡ä»¶å˜é‡è™šå‡å”¤é†’æ˜¯æŒ‡åœ¨ä½¿ç”¨æ¡ä»¶å˜é‡è¿›è¡Œçº¿ç¨‹åŒæ­¥æ—¶ï¼Œæœ‰æ—¶å€™çº¿ç¨‹å¯èƒ½ä¼šåœ¨æ²¡æœ‰æ”¶åˆ°é€šçŸ¥çš„æƒ…å†µä¸‹è¢«å”¤é†’ã€‚é—®é¢˜å–å†³äºç¨‹åºå’Œç³»ç»Ÿçš„å…·ä½“å®ç°ã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåœ¨å¾ªç¯ä¸­ç­‰å¾…å¹¶åˆ¤æ–­æ¡ä»¶å¯ä¸€å¹¶è§£å†³ã€‚ä½¿ç”¨ C++ æ ‡å‡†åº“åˆ™æ²¡æœ‰è¿™ä¸ªçƒ¦æ¼äº†ã€‚ ","date":"2025-03-24","objectID":"/2025/4b155bd/:1:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰","uri":"/2025/4b155bd/"},{"categories":["å…«è‚¡"],"content":"çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ— è¿™é‡Œä»‹ç»ä¸€ä¸ªæ›´ä¸ºå¤æ‚çš„ç¤ºä¾‹ï¼Œç”¨äºå·©å›ºæ¡ä»¶å˜é‡çš„å­¦ä¹ ã€‚åœ¨å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ³¨æ„ä¸¤ç‚¹å†…å®¹ï¼š å½“æ‰§è¡Œ push æ“ä½œæ—¶ï¼Œéœ€è¦ç¡®ä¿æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ push æˆ– pop æ“ä½œï¼›åŒæ ·ï¼Œåœ¨æ‰§è¡Œ pop æ“ä½œæ—¶ï¼Œä¹Ÿéœ€è¦ç¡®ä¿æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ push æˆ– pop æ“ä½œã€‚ å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¸åº”è¯¥æ‰§è¡Œ pop æ“ä½œã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ¡ä»¶å˜é‡æ¥ä¼ é€’ä¸€ä¸ªè°“è¯ï¼Œä»¥ç¡®ä¿åœ¨æ‰§è¡Œ pop æ“ä½œæ—¶é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ¨¡ç‰ˆç±» threadsafe_queueï¼š template\u003ctypename T\u003e class threadsafe_queue { mutable std::mutex m; // äº’æ–¥é‡ï¼Œç”¨äºä¿æŠ¤é˜Ÿåˆ—æ“ä½œçš„ç‹¬å è®¿é—® std::condition_variable data_cond; // æ¡ä»¶å˜é‡ï¼Œç”¨äºåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ç­‰å¾… std::queue\u003cT\u003e data_queue; // å®é™…å­˜å‚¨æ•°æ®çš„é˜Ÿåˆ— public: threadsafe_queue() {} // æ— å‚æ„é€  void push(T new_value) { { std::lock_guard\u003cstd::mutex\u003e lk { m }; data_queue.push(new_value); } data_cond.notify_one(); } // ä»é˜Ÿåˆ—ä¸­å¼¹å‡ºå…ƒç´ ï¼ˆé˜»å¡ç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºï¼‰ void pop(T\u0026 value) { std::unique_lock\u003cstd::mutex\u003e lk{ m }; data_cond.wait(lk, [this] {return !data_queue.empty(); }); // è¿™é‡Œçš„ this è¡¨ç¤ºæŒ‰å€¼ä¼ é€’ thisï¼Œè§ lambda è¡¨è¾¾å¼ç”¨æ³• value = data_queue.front(); data_queue.pop(); } // ä»é˜Ÿåˆ—ä¸­å¼¹å‡ºå…ƒç´ ï¼ˆé˜»å¡ç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘å¼¹å‡ºå…ƒç´ çš„ shared_ptr std::shared_ptr\u003cT\u003e pop() { std::unique_lock\u003cstd::mutex\u003e lk{ m }; data_cond.wait(lk, [this] {return !data_queue.empty(); }); std::shared_ptr\u003cT\u003e res { std::make_shared\u003cT\u003e(data_queue.front()) }; data_queue.pop(); return res; } bool empty()const { std::lock_guard\u003cstd::mutex\u003e lk (m); return data_queue.empty(); } }; ","date":"2025-03-24","objectID":"/2025/4b155bd/:2:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰","uri":"/2025/4b155bd/"},{"categories":["å…«è‚¡"],"content":"ä½¿ç”¨ future ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åœ¨è½¦ç«™ç­‰è½¦ï¼Œä½ å¯èƒ½ä¼šåšä¸€äº›åˆ«çš„äº‹æƒ…æ‰“å‘æ—¶é—´ï¼Œæ¯”å¦‚å­¦ä¹ ç°ä»£C++å¹¶å‘ç¼–ç¨‹æ•™ç¨‹ã€ç©æ‰‹æœºç­‰ï¼Œä½†å§‹ç»ˆåœ¨ç­‰å¾…ä¸€ä»¶äº‹æƒ…ï¼šè½¦åˆ°ç«™ã€‚ C++ æ ‡å‡†åº“å°†è¿™ç§äº‹ä»¶ç§°ä¸º futureã€‚å®ƒç”¨äºå¤„ç†çº¿ç¨‹ä¸­éœ€è¦ç­‰å¾…æŸä¸ªäº‹ä»¶çš„æƒ…å†µï¼Œçº¿ç¨‹çŸ¥é“é¢„æœŸç»“æœã€‚ç­‰å¾…çš„åŒæ—¶ä¹Ÿå¯ä»¥æ‰§è¡Œå…¶å®ƒçš„ä»»åŠ¡ã€‚ C++ æ ‡å‡†åº“æœ‰ä¸¤ç§ futureï¼Œéƒ½å£°æ˜åœ¨ \u003cfuture\u003e å¤´æ–‡ä»¶ä¸­ï¼šç‹¬å çš„ std::future ã€å…±äº«çš„ std::shared_futureã€‚å®ƒä»¬çš„åŒºåˆ«ä¸ std::unique_ptr å’Œ std::shared_ptr ç±»ä¼¼ã€‚std::future åªèƒ½ä¸å•ä¸ªæŒ‡å®šäº‹ä»¶å…³è”ï¼Œè€Œ std::shared_future èƒ½å…³è”å¤šä¸ªäº‹ä»¶ã€‚å®ƒä»¬éƒ½æ˜¯æ¨¡æ¿ï¼Œå®ƒä»¬çš„æ¨¡æ¿ç±»å‹å‚æ•°ï¼Œå°±æ˜¯å…¶å…³è”çš„äº‹ä»¶ï¼ˆå‡½æ•°ï¼‰çš„è¿”å›ç±»å‹ã€‚å½“å¤šä¸ªçº¿ç¨‹éœ€è¦è®¿é—®ä¸€ä¸ªç‹¬ç«‹ future å¯¹è±¡æ—¶ï¼Œ å¿…é¡»ä½¿ç”¨äº’æ–¥é‡æˆ–ç±»ä¼¼åŒæ­¥æœºåˆ¶è¿›è¡Œä¿æŠ¤ã€‚è€Œå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€å…±äº«çŠ¶æ€ï¼Œè‹¥æ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯é€šè¿‡å…¶è‡ªèº«çš„ shared_future å¯¹è±¡å‰¯æœ¬è¿›è¡Œè®¿é—®ï¼Œåˆ™æ˜¯å®‰å…¨çš„ã€‚ æœ€ç®€å•æœ‰æ•ˆçš„ä½¿ç”¨æ˜¯ï¼Œæˆ‘ä»¬å…ˆå‰è®²çš„ std::thread åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡æ˜¯æ²¡æœ‰è¿”å›å€¼çš„ï¼Œè¿™ä¸ªé—®é¢˜å°±èƒ½ä½¿ç”¨ future è§£å†³ã€‚ ","date":"2025-03-24","objectID":"/2025/4b155bd/:3:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰","uri":"/2025/4b155bd/"},{"categories":["å…«è‚¡"],"content":"åˆ›å»ºå¼‚æ­¥ä»»åŠ¡è·å–è¿”å›å€¼ å‡è®¾éœ€è¦æ‰§è¡Œä¸€ä¸ªè€—æ—¶ä»»åŠ¡å¹¶è·å–å…¶è¿”å›å€¼ï¼Œä½†æ˜¯å¹¶ä¸æ€¥åˆ‡çš„éœ€è¦å®ƒã€‚é‚£ä¹ˆå°±å¯ä»¥å¯åŠ¨æ–°çº¿ç¨‹è®¡ç®—ï¼Œç„¶è€Œ std::thread æ²¡æä¾›ç›´æ¥ä»çº¿ç¨‹è·å–è¿”å›å€¼çš„æœºåˆ¶ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ std::async å‡½æ•°æ¨¡æ¿ã€‚ ä½¿ç”¨ std::async å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª std::future å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å’Œä»»åŠ¡å…³è”ï¼Œå°†æŒæœ‰æœ€ç»ˆè®¡ç®—å‡ºæ¥çš„ç»“æœã€‚å½“éœ€è¦ä»»åŠ¡æ‰§è¡Œå®Œçš„ç»“æœçš„æ—¶å€™ï¼Œåªéœ€è¦è°ƒç”¨ get() æˆå‘˜å‡½æ•°ï¼Œå°±ä¼šé˜»å¡ç›´åˆ° future ä¸ºå°±ç»ªä¸ºæ­¢ï¼ˆå³ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼‰ï¼Œè¿”å›æ‰§è¡Œç»“æœã€‚valid() æˆå‘˜å‡½æ•°æ£€æŸ¥ future å½“å‰æ˜¯å¦å…³è”å…±äº«çŠ¶æ€ï¼Œå³æ˜¯å¦å½“å‰å…³è”ä»»åŠ¡ã€‚è¿˜æœªå…³è”ï¼Œæˆ–è€…ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œï¼ˆè°ƒç”¨äº† get()ã€set()ï¼‰ï¼Œéƒ½ä¼šè¿”å› falseã€‚ #include \u003ciostream\u003e #include \u003cthread\u003e #include \u003cfuture\u003e // å¼•å…¥ future å¤´æ–‡ä»¶ int task(int n) { std::cout \u003c\u003c \"å¼‚æ­¥ä»»åŠ¡ ID: \" \u003c\u003c std::this_thread::get_id() \u003c\u003c '\\n'; return n * n; } int main() { std::future\u003cint\u003e future = std::async(task, 10); std::cout \u003c\u003c \"main: \" \u003c\u003c std::this_thread::get_id() \u003c\u003c '\\n'; std::cout \u003c\u003c std::boolalpha \u003c\u003c future.valid() \u003c\u003c '\\n'; // true std::cout \u003c\u003c future.get() \u003c\u003c '\\n'; std::cout \u003c\u003c std::boolalpha \u003c\u003c future.valid() \u003c\u003c '\\n'; // false } å…³äº std::async çš„å‚æ•°ä¼ é€’ï¼Œè¿™é‡Œä¸å†å±•å¼€è®°å½•ï¼Œç”¨æ—¶å†æŸ¥ã€‚ ","date":"2025-03-24","objectID":"/2025/4b155bd/:3:1","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰","uri":"/2025/4b155bd/"},{"categories":["å…«è‚¡"],"content":"ä¿¡å·é‡ ä¿¡å·é‡æ˜¯ä¸€ä¸ªéå¸¸è½»é‡ç®€å•çš„åŒæ­¥è®¾æ–½ï¼ˆåœ¨ C++ 20ä¸­è¢«å¼•å…¥ï¼‰ï¼Œå®ƒç»´æŠ¤ä¸€ä¸ªè®¡æ•°ï¼Œè¿™ä¸ªè®¡æ•°ä¸èƒ½å°äº 0ã€‚ä¿¡å·é‡æä¾›ä¸¤ç§åŸºæœ¬æ“ä½œï¼šé‡Šæ”¾ï¼ˆå¢åŠ è®¡æ•°ï¼‰å’Œç­‰å¾…ï¼ˆå‡å°‘è®¡æ•°ï¼‰ã€‚å¦‚æœå½“å‰ä¿¡å·é‡çš„è®¡æ•°å€¼ä¸º 0ï¼Œé‚£ä¹ˆæ‰§è¡Œâ€œç­‰å¾…â€æ“ä½œçš„çº¿ç¨‹å°†ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è®¡æ•°å¤§äº 0ï¼Œä¹Ÿå°±æ˜¯å…¶å®ƒçº¿ç¨‹æ‰§è¡Œäº† â€œé‡Šæ”¾â€ æ“ä½œã€‚ C++ æä¾›äº†ä¸¤ä¸ªä¿¡å·é‡ç±»å‹ï¼šstd::counting_semaphore ä¸ std::binary_semaphoreï¼Œå®šä¹‰åœ¨ \u003csemaphore\u003e ä¸­ã€‚å…¶ä¸­ binary_semaphore åªæ˜¯ counting_semaphore çš„ä¸€ä¸ªç‰¹åŒ–åˆ«åï¼ˆå…¶ LeastMaxValue ä¸º1ï¼ŒLeastMaxValue æ„æ€æ˜¯ä¿¡å·é‡ç»´æŠ¤çš„è®¡æ•°æœ€å¤§å€¼ã€‚ï¼‰ï¼š using binary_semaphore = counting_semaphore\u003c1\u003e; ä¸¾ä¸ªå…·ä½“ä½¿ç”¨ä¿¡å·é‡çš„ä¾‹å­ï¼š // å…¨å±€äºŒå…ƒä¿¡å·é‡å¯¹è±¡ // è®¾ç½®å¯¹è±¡åˆå§‹è®¡æ•°ä¸º 0 std::binary_semaphore smph_signal_main_to_thread{ 0 }; std::binary_semaphore smph_signal_thread_to_main{ 0 }; void thread_proc() { smph_signal_main_to_thread.acquire(); std::cout \u003c\u003c \"[çº¿ç¨‹] è·å¾—ä¿¡å·\" \u003c\u003c std::endl; std::this_thread::sleep_for(3s); std::cout \u003c\u003c \"[çº¿ç¨‹] å‘é€ä¿¡å·\\n\"; smph_signal_thread_to_main.release(); } int main() { std::jthread thr_worker{ thread_proc }; std::cout \u003c\u003c \"[ä¸»] å‘é€ä¿¡å·\\n\"; smph_signal_main_to_thread.release(); smph_signal_thread_to_main.acquire(); std::cout \u003c\u003c \"[ä¸»] è·å¾—ä¿¡å·\\n\"; } ç»“æœï¼š [ä¸»] å‘é€ä¿¡å· [çº¿ç¨‹] è·å¾—ä¿¡å· [çº¿ç¨‹] å‘é€ä¿¡å· [ä¸»] è·å¾—ä¿¡å· acquire å‡½æ•°å°±æ˜¯æˆ‘ä»¬å…ˆå‰è¯´çš„â€œç­‰å¾…â€ï¼ˆåŸå­åœ°å‡å°‘è®¡æ•°ï¼‰ï¼Œrelease å‡½æ•°å°±æ˜¯\"é‡Šæ”¾\"ï¼ˆåŸå­åœ°å¢åŠ è®¡æ•°ï¼‰ã€‚ æç¤º ä¿¡å·é‡å¸¸ç”¨äº å‘ä¿¡/æé†’ è€Œéäº’æ–¥ï¼Œé€šè¿‡åˆå§‹åŒ–è¯¥ä¿¡å·é‡ä¸º 0 ä»è€Œé˜»å¡å°è¯• acquire() çš„æ¥æ”¶è€…ï¼Œç›´è‡³æé†’è€…é€šè¿‡è°ƒç”¨ release(n) â€œå‘ä¿¡â€ã€‚åœ¨æ­¤æ–¹é¢å¯æŠŠä¿¡å·é‡å½“ä½œæ¡ä»¶å˜é‡çš„æ›¿ä»£å“ï¼Œé€šå¸¸å®ƒæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œå®ƒåªèƒ½å¤„ç†æœ‰é™æ•°é‡çš„å¹¶å‘è¯·æ±‚ã€‚ä¸ºäº†é˜²æ­¢æœåŠ¡å™¨è¿‡è½½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¿¡å·é‡æ¥é™åˆ¶å¹¶å‘è¯·æ±‚çš„æ•°é‡ã€‚ // å®šä¹‰ä¸€ä¸ªä¿¡å·é‡ï¼Œæœ€å¤§å¹¶å‘æ•°ä¸º 3 std::counting_semaphore\u003c3\u003e semaphore{ 3 }; // counting_semaphore è½»é‡åŒæ­¥åŸè¯­ï¼Œå…è®¸åŒä¸€èµ„æºè¿›è¡Œå¤šä¸ªå¹¶å‘çš„è®¿é—®ï¼Œè‡³å°‘å…è®¸ LeastMaxValue ä¸ªåŒæ—¶è®¿é—®è€… void handle_request(int request_id) { // è¯·æ±‚åˆ°è¾¾ï¼Œå°è¯•è·å–ä¿¡å·é‡ std::cout \u003c\u003c \"è¿›å…¥ handle_request å°è¯•è·å–ä¿¡å·é‡\\n\"; semaphore.acquire(); std::cout \u003c\u003c \"æˆåŠŸè·å–ä¿¡å·é‡\\n\"; // æ­¤å¤„å»¶æ—¶ä¸‰ç§’å¯ä»¥æ–¹ä¾¿æµ‹è¯•ï¼Œä¼šçœ‹åˆ°å…ˆè¾“å‡º 3 ä¸ªâ€œæˆåŠŸè·å–ä¿¡å·é‡â€ï¼Œå› ä¸ºåªæœ‰ä¸‰ä¸ªçº¿ç¨‹èƒ½æˆåŠŸè°ƒç”¨ acquireï¼Œå‰©ä½™çš„ä¼šè¢«é˜»å¡ std::this_thread::sleep_for(3s); // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´ std::random_device rd; std::mt19937 gen{ rd() }; std::uniform_int_distribution\u003c\u003e dis(1, 5); int processing_time = dis(gen); std::this_thread::sleep_for(std::chrono::seconds(processing_time)); std::cout \u003c\u003c std::format(\"è¯·æ±‚ {} å·²è¢«å¤„ç†\\n\", request_id); semaphore.release(); } int main() { // æ¨¡æ‹Ÿ 10 ä¸ªå¹¶å‘è¯·æ±‚ std::vector\u003cstd::jthread\u003e threads; for (int i = 0; i \u003c 10; ++i) { threads.emplace_back(handle_request, i); } } ç‰¢è®°ä¿¡å·é‡çš„åŸºæœ¬çš„æ¦‚å¿µä¸å˜ï¼Œè®¡æ•°çš„å€¼ä¸èƒ½å°äº 0ï¼Œå¦‚æœå½“å‰ä¿¡å·é‡çš„è®¡æ•°å€¼ä¸º 0ï¼Œé‚£ä¹ˆæ‰§è¡Œ â€œç­‰å¾…â€ï¼ˆacquireï¼‰ æ“ä½œçš„çº¿ç¨‹å°†ä¼šä¸€ç›´é˜»å¡ã€‚æ˜ç™½è¿™ç‚¹ï¼Œé‚£ä¹ˆå°±éƒ½ä¸å­˜åœ¨é—®é¢˜ã€‚ ","date":"2025-03-24","objectID":"/2025/4b155bd/:4:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰","uri":"/2025/4b155bd/"},{"categories":["å…«è‚¡"],"content":"ã€Šç°ä»£C++å¹¶å‘ç¼–ç¨‹æ•™ç¨‹ã€‹ â€”â€” C++å¹¶å‘ç¼–ç¨‹å­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ ","date":"2025-03-23","objectID":"/2025/acc27a1/:0:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"å¯åŠ¨çº¿ç¨‹ #include \u003ciostream\u003e #include \u003cthread\u003e void hello() { printf(\"hello world!\\n\"); } int main() { std::thread my_thread(hello); } å¯ä»¥ä¼ å…¥å‡½æ•°å¯¹è±¡ï¼Œå¦‚ä¸Šä¾‹æ‰€ç¤ºã€‚ä¹Ÿå¯ä»¥ä¼ å…¥ç±»æˆ–è€…å…¶ä»–é‡è½½äº† () ï¼ˆcallableï¼‰è¿ç®—ç¬¦çš„å¯¹è±¡ï¼Œä¾‹å¦‚ï¼š class task { public: void operator()() const { do_something(); do_something_else(); } }; task f; std::thread my_thread(f); ä½†è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œç”±äº C++ çš„è¯­æ³•é—®é¢˜ï¼Œæœ‰æ—¶ä¼šé€ æˆæ­§ä¹‰ï¼Œä¾‹å¦‚ï¼š std::thread my_thread(task()); // è¿™ä¼šè¢«è®¤ä¸ºæ˜¯å£°æ˜äº†ä¸€ä¸ªè¿”å›å€¼ä¸º thread çš„ï¼Œåä¸º my_thread çš„å‡½æ•° è¿™é‡Œæœ€å¥½ä½¿ç”¨ {} è¿ç®—ç¬¦æ¥åˆ›å»ºä¸€ä¸ª thread å¯¹è±¡ï¼Œå¦‚ï¼š std::thread my_thread{task()}ã€‚åŒæ—¶ä¹Ÿå¯ä»¥ç”¨åŒ¿åå‡½æ•°ï¼ˆlambdaè¡¨è¾¾å¼ï¼‰æ¥åˆ›å»ºçº¿ç¨‹ï¼š #include \u003ciostream\u003e #include \u003cthread\u003e int main() { std::thread thread{ [] {std::cout \u003c\u003c \"Hello World!\\n\"; } }; thread.join(); } å½“ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åˆ›å»ºæ—¶ï¼ˆå³ std::thread å¯¹è±¡æ„é€ æ—¶ï¼‰å°±å¼€å§‹æ‰§è¡Œä¼ å…¥çš„å‡½æ•° f äº†ã€‚ ","date":"2025-03-23","objectID":"/2025/acc27a1/:1:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"çº¿ç¨‹ç®¡ç† å¯åŠ¨çº¿ç¨‹åï¼ˆæ„é€  std::thread å¯¹è±¡ï¼‰ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç»“æŸä¹‹å‰ï¼Œå³ std::thread::~thread è°ƒç”¨ä¹‹å‰ï¼Œå†³å®šå®ƒçš„æ‰§è¡Œç­–ç•¥ï¼ŒåŒ…æ‹¬ join() å’Œ detach()ã€‚ ","date":"2025-03-23","objectID":"/2025/acc27a1/:2:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"join() å…¶ä¸­ join() è¡¨ç¤ºå°†é˜»å¡å…³è”çš„çº¿ç¨‹ï¼Œç›´è‡³æ‰§è¡Œå®Œæ¯•ã€‚å†…éƒ¨å®ç°ä¼šè®© std::thread::joinable() è¿”å› falseã€‚å¦åˆ™ä¼šè¿”å› trueï¼Œæ‰§è¡Œ std::terminate()ã€‚ ","date":"2025-03-23","objectID":"/2025/acc27a1/:2:1","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"detach() æ‰§è¡Œäº† detach() åï¼Œè¡¨ç¤ºçº¿ç¨‹å¯¹è±¡æ”¾å¼ƒäº†å¯¹çº¿ç¨‹èµ„æºçš„æ‰€æœ‰æƒï¼Œå…è®¸æ­¤çº¿ç¨‹çš„ç‹¬ç«‹è¿è¡Œï¼Œåœ¨çº¿ç¨‹é€€å‡ºæ—¶é‡Šæ”¾æ‰€æœ‰åˆ†é…çš„èµ„æºã€‚é€šå¸¸ä¸å»ºè®®ä½¿ç”¨ detach()ï¼Œå¯ä»¥ç”¨ join() æ›¿ä»£ã€‚ å¯ä»¥æä¾›ä¸€ä¸ªç±»ï¼ŒRAIIï¼ˆResource Acquisition Initilizationï¼‰åœ°ç¡®ä¿çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œçº¿ç¨‹å¯¹è±¡æ­£å¸¸ææ„é‡Šæ”¾èµ„æºï¼š class thread_guard { std::thread\u0026 m_t; public: explicit thread_guard(std::thread\u0026 t) : m_t{ t } {} ~thread_guard() { std::puts(\"ææ„\"); // æ‰“å°æ—¥å¿— ä¸ç”¨åœ¨ä¹ if (m_t.joinable()) { // çº¿ç¨‹å¯¹è±¡å½“å‰å…³è”äº†æ´»è·ƒçº¿ç¨‹ m_t.join(); } } thread_guard(const thread_guard\u0026) = delete; thread_guard\u0026 operator=(const thread_guard\u0026) = delete; }; void f() { int n = 0; std::thread t{ func{n},10 }; thread_guard g(t); f2(); // å¯èƒ½æŠ›å‡ºå¼‚å¸¸ } ","date":"2025-03-23","objectID":"/2025/acc27a1/:2:2","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"ä¼ é€’å‚æ•° å‘å¯è°ƒç”¨å¯¹è±¡ä¼ é€’å‚æ•°ï¼Œåªéœ€è¦å°†è¿™äº›å‚æ•°ä½œä¸º std::thread çš„æ„é€ å‚æ•°å³å¯ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›å‚æ•°ä¼šå¤åˆ¶åˆ°æ–°çº¿ç¨‹çš„å†…å­˜ç©ºé—´ä¸­ï¼Œå³ä½¿å‡½æ•°ä¸­çš„å‚æ•°æ˜¯å¼•ç”¨ï¼Œä¾ç„¶å®é™…æ˜¯å¤åˆ¶ã€‚ void f(int, const int\u0026 a); int n = 1; std::thread t{ f, 3, n }; çº¿ç¨‹å¯¹è±¡ t çš„æ„é€ æ²¡æœ‰é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ç¼–è¯‘ï¼Œä½†æ˜¯è¿™ä¸ª n å®é™…ä¸Šå¹¶æ²¡æœ‰æŒ‰å¼•ç”¨ä¼ é€’ï¼Œè€Œæ˜¯æŒ‰å€¼å¤åˆ¶çš„ã€‚å¦‚æœæˆ‘ä»¬çš„ f çš„å½¢å‚ç±»å‹ä¸æ˜¯ const çš„å¼•ç”¨ï¼Œåˆ™ä¼šäº§ç”Ÿä¸€ä¸ªç¼–è¯‘é”™è¯¯ã€‚å¯ä»¥ç”¨æ ‡å‡†åº“çš„ std::refã€std::cref å‡½æ•°æ¨¡ç‰ˆã€‚ void f(int, int\u0026 a) { std::cout \u003c\u003c \u0026a \u003c\u003c '\\n'; } int main() { int n = 1; std::cout \u003c\u003c \u0026n \u003c\u003c '\\n'; std::thread t { f, 3, std::ref(n) }; t.join(); } ","date":"2025-03-23","objectID":"/2025/acc27a1/:3:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"å…±äº«æ•°æ® æˆ‘ä»¬éƒ½çŸ¥é“çº¿ç¨‹é€šä¿¡çš„æ–¹å¼æœ‰ä¸´ç•ŒåŒºã€äº’æ–¥é‡ã€ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”ï¼š ä¸´ç•ŒåŒºï¼šæ¯ä¸ªçº¿ç¨‹ä¸­è®¿é—®ä¸´ç•Œèµ„æºçš„é‚£æ®µä»£ç ç§°ä¸ºä¸´ç•ŒåŒºï¼ˆCritical Sectionï¼‰ï¼ˆä¸´ç•Œèµ„æºæ˜¯ä¸€æ¬¡ä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨çš„å…±äº«èµ„æºï¼‰ã€‚æ¯æ¬¡åªå‡†è®¸ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œè¿›å…¥åä¸å…è®¸å…¶ä»–çº¿ç¨‹è¿›å…¥ã€‚ä¸è®ºæ˜¯ç¡¬ä»¶ä¸´ç•Œèµ„æºï¼Œè¿˜æ˜¯è½¯ä»¶ä¸´ç•Œèµ„æºï¼Œå¤šä¸ªçº¿ç¨‹å¿…é¡»äº’æ–¥åœ°å¯¹å®ƒè¿›è¡Œè®¿é—®ã€‚åœ¨ä¸´ç•ŒåŒºä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨åŒæ­¥æœºåˆ¶ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦è®²çš„äº’æ–¥é‡ï¼ˆMutexï¼‰ äº’æ–¥é‡ï¼šé‡‡ç”¨äº’æ–¥å¯¹è±¡æœºåˆ¶ï¼Œåªæœ‰æ‹¥æœ‰äº’æ–¥å¯¹è±¡çš„çº¿ç¨‹æ‰å¯ä»¥è®¿é—®ã€‚å› ä¸ºäº’æ–¥å¯¹è±¡åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯å…¬å…±èµ„æºä¸ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ã€‚ ä¿¡å·é‡ï¼šè®¡æ•°å™¨ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªèµ„æºã€‚ æ¡ä»¶å˜é‡ï¼šé€šè¿‡æ¡ä»¶å˜é‡é€šçŸ¥æ“ä½œçš„æ–¹å¼æ¥ä¿æŒå¤šçº¿ç¨‹åŒæ­¥ã€‚ è¯»å†™é”ï¼šè¯»å†™é”ä¸äº’æ–¥é‡ç±»ä¼¼ã€‚ä½†äº’æ–¥é‡è¦ä¹ˆæ˜¯é”ä½çŠ¶æ€ï¼Œè¦ä¹ˆå°±æ˜¯ä¸åŠ é”çŠ¶æ€ã€‚è¯»å†™é”ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™ï¼Œä½†å…è®¸ä¸€æ¬¡å¤šä¸ªçº¿ç¨‹è¯»ï¼Œè¿™æ ·æ•ˆç‡å°±æ¯”äº’æ–¥é”è¦é«˜ã€‚ å¦‚æœæœ‰ä»¥ä¸‹æƒ…å†µï¼Œå‡ºç°æ•°æ®ç«äº‰æƒ…å†µã€‚ std::vector\u003cint\u003e v; void f() { v.emplace_back(1); } void f2() { v.erase(v.begin()); } int main() { std::thread t{ f }; std::thread t2{ f2 }; t.join(); t2.join(); std::cout \u003c\u003c v.size() \u003c\u003c '\\n'; // æœ‰æ—¶å‡ºç°æ®µé”™è¯¯ï¼Œæœ‰æ—¶è¾“å‡º0ï¼Œä¸ç¨³å®šçš„è¾“å‡ºç»“æœ } è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨äº’æ–¥é‡æ¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚ #include \u003ciostream\u003e #include \u003cmutex\u003e #include \u003cthread\u003e #include \u003cvector\u003e std::mutex m; std::vector\u003cint\u003e v; void f() { m.lock(); v.emplace_back(1); m.unlock(); } void f2() { m.lock(); v.erase(v.begin()); m.unlock(); } int main() { std::thread t{ f }; std::thread t2{ f2 }; t.join(); t2.join(); std::cout \u003c\u003c v.size() \u003c\u003c '\\n'; // ç¨³å®šè¾“å‡º0 } å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œä½¿ç”¨ mutex äº’æ–¥é‡å‰ï¼š void f() { // this_thread::get_id() è¡¨ç¤ºè·å–å½“å‰çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä»¥ä¾¿åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­åŒºåˆ†ä¸åŒçš„çº¿ç¨‹ã€‚ std::cout \u003c\u003c std::this_thread::get_id() \u003c\u003c '\\n'; } int main() { std::vector\u003cstd::thread\u003e threads; for (std::size_t i = 0; i \u003c 10; ++i) threads.emplace_back(f); for (auto\u0026 thread : threads) thread.join(); } è¿™é‡Œæœ‰ä¸€ä¸ªç‚¹ï¼Œæ­£å¥½è¯´æ˜ä¸€ä¸‹ push_back() å’Œ emplace_back() çš„åŒºåˆ« å¦‚æœè¦ç”¨ push_backï¼Œåˆ™éœ€è¦å…ˆæ„é€ ä¸€ä¸ª thread ä¸´æ—¶å¯¹è±¡ï¼šthreads.push_back(std::thread(f)); è€Œå¦‚æœç”¨ emplace_backï¼Œè¯¥æ–¹æ³•å…è®¸åœ¨ vector æœ«å°¾ç›´æ¥æ„é€ å¯¹è±¡ï¼Œè€Œæ— éœ€åˆ›å»ºä¸´æ—¶å¯¹è±¡ã€‚å®ƒæ¥å—æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œå¹¶åœ¨é€‚å½“çš„ä½ç½®ç›´æ¥è°ƒç”¨æ„é€ å‡½æ•°ã€‚è¿™æ ·å¯ä»¥å‡å°‘ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»ºå’Œç§»åŠ¨æ“ä½œï¼Œæé«˜æ€§èƒ½ï¼šthreads.emplace_back(f); ä½¿ç”¨åï¼š #include \u003cmutex\u003e // å¿…è¦æ ‡å¤´ std::mutex m; void f() { m.lock(); std::cout \u003c\u003c std::this_thread::get_id() \u003c\u003c '\\n'; m.unlock(); } int main() { std::vector\u003cstd::thread\u003ethreads; for (std::size_t i = 0; i \u003c 10; ++i) threads.emplace_back(f); for (auto\u0026 thread : threads) thread.join(); } å½“å¤šä¸ªçº¿ç¨‹æ‰§è¡Œå‡½æ•° f çš„æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸè°ƒç”¨ lock() ç»™äº’æ–¥é‡ä¸Šé”ï¼Œå…¶ä»–æ‰€æœ‰çš„çº¿ç¨‹ lock() çš„è°ƒç”¨å°†é˜»å¡æ‰§è¡Œï¼Œç›´è‡³è·å¾—é”ã€‚ç¬¬ä¸€ä¸ªè°ƒç”¨ lock() çš„çº¿ç¨‹å¾—ä»¥ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ‰§è¡Œæˆ‘ä»¬çš„ std::cout è¾“å‡ºè¯­å¥ï¼Œä¸ä¼šæœ‰ä»»ä½•å…¶ä»–çš„çº¿ç¨‹æ‰“æ–­è¿™ä¸ªæ“ä½œã€‚ç›´åˆ°çº¿ç¨‹æ‰§è¡Œ unlock()ï¼Œå°±è§£é”äº†äº’æ–¥é‡ã€‚é‚£ä¹ˆå…¶ä»–çº¿ç¨‹æ­¤æ—¶ä¹Ÿå°±èƒ½å†æœ‰ä¸€ä¸ªæˆåŠŸè°ƒç”¨ lockã€‚è‡³äºæ˜¯å“ªä¸ªçº¿ç¨‹æ‰ä¼šæˆåŠŸè°ƒç”¨ï¼Œè¿™ä¸ªæ˜¯ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦å†³å®šçš„ è¿™é‡Œæˆ‘ç†è§£çš„æ˜¯ï¼Œâ€œé”â€ æ˜¯ä¸€ç§å¹¿æ³›çš„æ¦‚å¿µï¼Œå¯ä»¥æœ‰å¤šç§å®ç°æ–¹å¼ï¼Œc++ ä¸­çš„äº’æ–¥é‡ mutex å¯ä»¥ç”¨æ¥å®ç°é” ","date":"2025-03-23","objectID":"/2025/acc27a1/:4:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"std::lock_guard ä¸€èˆ¬æ¥è¯´ï¼Œä¸å»ºè®®ç›´æ¥ä½¿ç”¨äº’æ–¥é‡ mutex æ˜¾å¼åœ°è¿›è¡Œ lock() å’Œ unlock()ã€‚å¯ä»¥ç”¨ C++11 æ ‡å‡†å¼•å…¥çš„ç®¡ç†ç±» std::lock_guard: void f() { std::lock_guard\u003cstd::mutex\u003e lc{ m }; // ç­‰ä»·äº m.lock()ï¼Œè¶…å‡ºä½œç”¨åŸŸè°ƒç”¨ææ„æ¥ unlock std::cout \u003c\u003c std::this_thread::get_id() \u003c\u003c '\\n'; } std::lock_guard å®ç°æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥çœ‹å®ƒåœ¨ MSVC STL ä¸­çš„å®ç°ã€‚ æˆ‘ä»¬è¦å°½å¯èƒ½çš„è®©äº’æ–¥é‡ä¸Šé”çš„ç²’åº¦å°ï¼Œåªç”¨æ¥ç¡®ä¿å¿…é¡»çš„å…±äº«èµ„æºçš„çº¿ç¨‹å®‰å…¨ã€‚ â€œç²’åº¦â€é€šå¸¸ç”¨äºæè¿°é”å®šçš„èŒƒå›´å¤§å°ï¼Œè¾ƒå°çš„ç²’åº¦æ„å‘³ç€é”å®šçš„èŒƒå›´æ›´å°ï¼Œå› æ­¤æœ‰æ›´å¥½çš„æ€§èƒ½å’Œæ›´å°‘çš„ç«äº‰ã€‚ æ¯”å¦‚æœ‰çš„æ—¶å€™å¯ä»¥çœ‹åˆ°è¿™æ ·çš„å†™æ³•ï¼š void f() { //code.. { std::lock_guard\u003cstd::mutex\u003e lc{ m }; // æ¶‰åŠå…±äº«èµ„æºçš„ä¿®æ”¹çš„ä»£ç ... } //code.. } ä½¿ç”¨ {} åˆ›å»ºäº†ä¸€ä¸ªå—ä½œç”¨åŸŸï¼Œé™åˆ¶äº†å¯¹è±¡ lc çš„ç”Ÿå­˜æœŸï¼Œè¿›å…¥ä½œç”¨åŸŸæ„é€  lock_guard çš„æ—¶å€™ä¸Šé”ï¼ˆlockï¼‰ï¼Œç¦»å¼€ä½œç”¨åŸŸææ„çš„æ—¶å€™è§£é”ï¼ˆunlockï¼‰ã€‚ ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š std::mutex m; void add_to_list(int n, std::list\u003cint\u003e\u0026 list) { std::vector\u003cint\u003e numbers(n + 1); std::iota(numbers.begin(), numbers.end(), 0); // iotaæ˜¯å¯¹vectorè¿›è¡Œé€’å¢ï¼ˆé»˜è®¤é€’å¢1ï¼‰èµ‹å€¼çš„æ–¹æ³•ï¼Œ0æ˜¯èµ·å§‹å€¼ int sum = std::accumulate(numbers.begin(), numbers.end(), 0); // 0æ˜¯èµ·å§‹å€¼ { std::lock_guard\u003cstd::mutex\u003e lc{ m }; list.push_back(sum); } } void print_list(const std::list\u003cint\u003e\u0026 list){ std::lock_guard\u003cstd::mutex\u003e lc{ m }; for(const auto\u0026 i : list){ std::cout \u003c\u003c i \u003c\u003c ' '; } std::cout \u003c\u003c '\\n'; } // ...... // std::list\u003cint\u003e list; std::thread t1{ add_to_list,i,std::ref(list) }; // ä¸Šé¢æåˆ°è¿‡ï¼Œä¼ å‚å³ä½¿æ˜¯å¼•ç”¨ï¼Œä¹Ÿä¼šè¢«å¤åˆ¶ï¼Œéœ€è¦ç”¨ std::ref std::thread t2{ add_to_list,i,std::ref(list) }; std::thread t3{ print_list,std::cref(list) }; // const å¼•ç”¨éœ€è¦ç”¨ std::cref std::thread t4{ print_list,std::cref(list) }; t1.join(); t2.join(); t3.join(); t4.join(); è¿™é‡Œçš„å…±äº«æ•°æ®åªæœ‰ listï¼Œ å…ˆçœ‹ add_to_listï¼Œåªæœ‰ list.push_back(sum) æ¶‰åŠåˆ°äº†å¯¹å…±äº«æ•°æ®çš„ä¿®æ”¹ï¼Œéœ€è¦è¿›è¡Œä¿æŠ¤ï¼Œå› æ­¤æˆ‘ä»¬ç”¨ {} åŒ…è£¹ã€‚ å‡½æ•° print_list() æ‰“å° listï¼Œç»™æ•´ä¸ªå‡½æ•°ä¸Šé”ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚æˆ‘ä»¬ä»£ç æ˜¯å¤šä¸ªçº¿ç¨‹æ‰§è¡Œè¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä¸¤ä¸ªå‡½æ•°å…±äº«äº†ä¸€ä¸ªé”ï¼Œè¿™æ ·ç¡®ä¿äº†å½“æ‰§è¡Œå‡½æ•° print_list() æ‰“å°çš„æ—¶å€™ï¼Œlist çš„çŠ¶æ€æ˜¯ç¡®å®šçš„ã€‚æ‰“å°å‡½æ•° print_list å’Œ add_to_list å‡½æ•°çš„ä¿®æ”¹æ“ä½œåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œã€‚print_list() ä¸å¯èƒ½çœ‹åˆ°æ­£åœ¨è¢« add_to_list() ä¿®æ”¹çš„ listã€‚ è‡³äºåˆ°åº•å“ªä¸ªå‡½æ•°å“ªä¸ªçº¿ç¨‹ä¼šå…ˆæ‰§è¡Œï¼Œæ‰§è¡Œå¤šå°‘æ¬¡ï¼Œè¿™äº›éƒ½ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦å†³å®šï¼Œä¹Ÿå®Œå…¨æœ‰å¯èƒ½è¿ç»­ 4 æ¬¡éƒ½æ˜¯æ‰§è¡Œå‡½æ•° print_list çš„çº¿ç¨‹æˆåŠŸè°ƒç”¨ lockï¼Œä¼šæ‰“å°å‡ºäº†ä¸€æ ·çš„å€¼ï¼Œè¿™éƒ½å¾ˆæ­£å¸¸ã€‚ ","date":"2025-03-23","objectID":"/2025/acc27a1/:4:1","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"try_lock try_lock æ˜¯äº’æ–¥é‡ä¸­çš„ä¸€ç§å°è¯•ä¸Šé”çš„æ–¹å¼ã€‚ä¸å¸¸è§„çš„ lock ä¸åŒï¼Œtry_lock ä¼šå°è¯•ä¸Šé”ï¼Œä½†å¦‚æœé”å·²ç»è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œåˆ™ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œæ˜¯ç«‹å³è¿”å›ã€‚ å®ƒçš„è¿”å›ç±»å‹æ˜¯ bool ï¼Œå¦‚æœä¸Šé”æˆåŠŸå°±è¿”å› trueï¼Œå¤±è´¥å°±è¿”å› falseã€‚ è¿™ç§æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å¾ˆæœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦ä¿æŠ¤ä¸´ç•ŒåŒºçš„åŒæ—¶ï¼Œåˆä¸æƒ³çº¿ç¨‹å› ä¸ºç­‰å¾…é”è€Œé˜»å¡çš„æƒ…å†µä¸‹ã€‚ std::mutex mtx; void thread_function(int id) { // å°è¯•åŠ é” if (mtx.try_lock()) { std::cout \u003c\u003c \"çº¿ç¨‹ï¼š\" \u003c\u003c id \u003c\u003c \" è·å¾—é”\" \u003c\u003c std::endl; // ä¸´ç•ŒåŒºä»£ç  std::this_thread::sleep_for(std::chrono::milliseconds(100)); // æ¨¡æ‹Ÿä¸´ç•ŒåŒºæ“ä½œ mtx.unlock(); // è§£é” std::cout \u003c\u003c \"çº¿ç¨‹ï¼š\" \u003c\u003c id \u003c\u003c \" é‡Šæ”¾é”\" \u003c\u003c std::endl; } else { std::cout \u003c\u003c \"çº¿ç¨‹ï¼š\" \u003c\u003c id \u003c\u003c \" è·å–é”å¤±è´¥ å¤„ç†æ­¥éª¤\" \u003c\u003c std::endl; } } å¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹è¿è¡Œè¿™æ®µä»£ç ï¼Œå¿…ç„¶æœ‰ä¸€ä¸ªçº¿ç¨‹æ— æ³•æˆåŠŸä¸Šé”ï¼Œè¦èµ° else çš„åˆ†æ”¯ã€‚ std::thread t1(thread_function, 1); std::thread t2(thread_function, 2); t1.join(); t2.join(); å¯èƒ½çš„è¿è¡Œç»“æœï¼š çº¿ç¨‹ï¼š1 è·å¾—é” çº¿ç¨‹ï¼š2 è·å–é”å¤±è´¥ å¤„ç†æ­¥éª¤ çº¿ç¨‹ï¼š1 é‡Šæ”¾é” å°å¿ƒ åˆ‡å‹¿å°†å—ä¿æŠ¤æ•°æ®çš„æŒ‡é’ˆæˆ–å¼•ç”¨ä¼ é€’åˆ°äº’æ–¥é‡ä½œç”¨åŸŸä¹‹å¤–ï¼Œä¸ç„¶ä¿æŠ¤å°†å½¢åŒè™šè®¾ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“ä¾‹å­ class Data { int a{}; std::string b{}; public: void do_something() { // ä¿®æ”¹æ•°æ®æˆå‘˜ç­‰... } }; class Data_wrapper { Data data; std::mutex m; public: template\u003cclass Func\u003e void process_data(Func func) { std::lock_guard\u003cstd::mutex\u003e lc{m}; func(data); // å—ä¿æŠ¤æ•°æ®ä¼ é€’ç»™å‡½æ•° } }; Data* p = nullptr; void malicious_function(Data\u0026 protected_data) { p = \u0026protected_data; // å—ä¿æŠ¤çš„æ•°æ®è¢«ä¼ é€’åˆ°å¤–éƒ¨ } Data_wrapper d; void foo() { d.process_data(malicious_function); // ä¼ é€’äº†ä¸€ä¸ªæ¶æ„çš„å‡½æ•° p-\u003edo_something(); // åœ¨æ— ä¿æŠ¤çš„æƒ…å†µä¸‹è®¿é—®ä¿æŠ¤æ•°æ® } æˆå‘˜å‡½æ•°æ¨¡æ¿ process_data çœ‹èµ·æ¥ä¸€ç‚¹é—®é¢˜ä¹Ÿæ²¡æœ‰ï¼Œä½¿ç”¨ std::lock_guard å¯¹æ•°æ®åšäº†ä¿æŠ¤ï¼Œä½†æ˜¯è°ƒç”¨æ–¹ä¼ é€’äº† malicious_function è¿™æ ·ä¸€ä¸ªæ¶æ„çš„å‡½æ•°ï¼Œä½¿å—ä¿æŠ¤æ•°æ®ä¼ é€’ç»™å¤–éƒ¨ï¼Œå¯ä»¥åœ¨æ²¡æœ‰è¢«äº’æ–¥é‡ä¿æŠ¤çš„æƒ…å†µä¸‹è°ƒç”¨ do_something()ã€‚ ","date":"2025-03-23","objectID":"/2025/acc27a1/:4:2","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"æ­»é”ï¼šé—®é¢˜ä¸è§£å†³ ä¸¤ä¸ªçº¿ç¨‹éœ€è¦å¯¹å®ƒä»¬æ‰€æœ‰çš„äº’æ–¥é‡åšä¸€äº›æ“ä½œï¼Œå…¶ä¸­æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªäº’æ–¥é‡ï¼Œä¸”ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„äº’æ–¥é‡è§£é”ã€‚å› ä¸ºå®ƒä»¬éƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾äº’æ–¥é‡ï¼Œæ²¡æœ‰çº¿ç¨‹å·¥ä½œã€‚ è¿™ç§æƒ…å†µå°±æ˜¯æ­»é”ã€‚ä¸€èˆ¬åªæœ‰å¤šä¸ªäº’æ–¥é‡æ‰ä¼šé‡åˆ°æ­»é”é—®é¢˜ é¿å…æ­»é”çš„ä¸€èˆ¬å»ºè®®æ˜¯è®©ä¸¤ä¸ªäº’æ–¥é‡ä»¥ç›¸åŒçš„é¡ºåºä¸Šé”ï¼Œæ€»åœ¨äº’æ–¥é‡ B ä¹‹å‰é”ä½äº’æ–¥é‡ Aï¼Œå°±é€šå¸¸ä¸ä¼šæ­»é”ã€‚åé¢ç¤ºä¾‹ï¼š std::mutex m1,m2; std::size_t n{}; void f() { std::lock_guard\u003cstd::mutex\u003e lc1{ m1 }; std::lock_guard\u003cstd::mutex\u003e lc2{ m2 }; ++n; } void f2() { std::lock_guard\u003cstd::mutex\u003e lc1{ m2 }; std::lock_guard\u003cstd::mutex\u003e lc2{ m1 }; ++n; } f ä¸ f2 å› ä¸ºäº’æ–¥é‡ä¸Šé”é¡ºåºä¸åŒï¼Œå°±æœ‰æ­»é”é£é™©ã€‚å‡½æ•° f å…ˆé”å®š m1ï¼Œç„¶åå†å°è¯•é”å®š m2ï¼Œè€Œå‡½æ•° f2 å…ˆé”å®š m2 å†é”å®š m1 ã€‚å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œå®ƒä»¬å°±å¯èƒ½ï¼ˆå…·ä½“è·å¾—é”çš„é¡ºåºç”±æ“ä½œç³»ç»Ÿè°ƒåº¦å†³å®šï¼Œä¸Šé¢é˜è¿°è¿‡ï¼‰ä¼šå½¼æ­¤ç­‰å¾…å¯¹æ–¹é‡Šæ”¾å…¶æ‰€éœ€çš„é”ï¼Œä»è€Œé€ æˆæ­»é”ã€‚ ä½†æœ‰æ—¶å€™å³ä½¿å›ºå®šäº†é”çš„é¡ºåºï¼Œä¾æ—§ä¼šäº§ç”Ÿé—®é¢˜ã€‚å½“æœ‰å¤šä¸ªäº’æ–¥é‡ä¿æŠ¤åŒä¸€ä¸ªç±»çš„å¯¹è±¡æ—¶ï¼Œå¯¹äºç›¸åŒç±»å‹çš„ä¸¤ä¸ªä¸åŒå¯¹è±¡è¿›è¡Œæ•°æ®çš„äº¤æ¢æ“ä½œï¼Œä¸ºäº†ä¿è¯æ•°æ®äº¤æ¢çš„æ­£ç¡®æ€§ï¼Œå°±è¦é¿å…å…¶å®ƒçº¿ç¨‹ä¿®æ”¹ï¼Œç¡®ä¿æ¯ä¸ªå¯¹è±¡çš„äº’æ–¥é‡éƒ½é”ä½è‡ªå·±è¦ä¿æŠ¤çš„åŒºåŸŸã€‚å¦‚æœæŒ‰ç…§å‰é¢çš„çš„é€‰æ‹©ä¸€ä¸ªå›ºå®šçš„é¡ºåºä¸Šé”è§£é”ï¼Œåˆ™æ¯«æ— æ„ä¹‰ï¼Œæ¯”å¦‚ï¼š struct X { X(const std::string\u0026 str) :object{ str } {} friend void swap(X\u0026 lhs, X\u0026 rhs); private: std::string object; std::mutex m; }; void swap(X\u0026 lhs, X\u0026 rhs) { if (\u0026lhs == \u0026rhs) return; std::lock_guard\u003cstd::mutex\u003e lock1{ lhs.m }; std::lock_guard\u003cstd::mutex\u003e lock2{ rhs.m }; swap(lhs.object, rhs.object); } è€ƒè™‘ç”¨æˆ·è°ƒç”¨çš„æ—¶å€™å°†å‚æ•°äº¤æ¢ï¼Œå°±ä¼šäº§ç”Ÿæ­»é”ï¼š X a{ \"ğŸ¤£\" }, b{ \"ğŸ˜…\" }; std::thread t{ [\u0026] {swap(a, b); } }; // 1 std::thread t2{ [\u0026] {swap(b, a); } }; // 2 1 æ‰§è¡Œçš„æ—¶å€™ï¼Œå…ˆä¸Šé” a çš„äº’æ–¥é‡ï¼Œå†ä¸Šé” b çš„äº’æ–¥é‡ã€‚ 2 æ‰§è¡Œçš„æ—¶å€™ï¼Œå…ˆä¸Šé” b çš„äº’æ–¥é‡ï¼Œå†ä¸Šé” a çš„äº’æ–¥é‡ã€‚ å®Œå…¨å¯èƒ½çº¿ç¨‹ A æ‰§è¡Œ 1 çš„æ—¶å€™ä¸Šé”äº† a çš„äº’æ–¥é‡ï¼Œçº¿ç¨‹ B æ‰§è¡Œ 2 ä¸Šé”äº† b çš„äº’æ–¥é‡ã€‚çº¿ç¨‹ A å¾€ä¸‹æ‰§è¡Œéœ€è¦ä¸Šé” b çš„äº’æ–¥é‡ï¼Œçº¿ç¨‹ B åˆ™è¦ä¸Šé” a çš„äº’æ–¥é‡æ‰§è¡Œå®Œæ¯•æ‰èƒ½è§£é”ï¼Œå“ªä¸ªéƒ½æ²¡åŠæ³•å¾€ä¸‹æ‰§è¡Œï¼Œæ­»é”ã€‚ å¦‚ä½•è§£å†³ï¼Ÿå¯ä»¥ä½¿ç”¨ C++ æ ‡å‡†åº“ä¸­çš„ std::lockï¼Œå®ƒèƒ½ä¸€æ¬¡æ€§é”ä½å¤šä¸ªäº’æ–¥é‡ï¼Œå¹¶ä¸”æ²¡æœ‰æ­»é”é£é™©ã€‚ä¿®æ”¹å swap ä»£ç å¦‚ä¸‹ï¼š void swap(X\u0026 lhs, X\u0026 rhs) { if (\u0026lhs == \u0026rhs) return; std::lock(lhs.m, rhs.m); // ç»™ä¸¤ä¸ªäº’æ–¥é‡ä¸Šé” std::lock_guard\u003cstd::mutex\u003e lock1{ lhs.m,std::adopt_lock }; std::lock_guard\u003cstd::mutex\u003e lock2{ rhs.m,std::adopt_lock }; swap(lhs.object, rhs.object); } å› ä¸ºå‰é¢å·²ç»ä½¿ç”¨äº† std::lock ä¸Šé”ï¼Œæ‰€ä»¥åé¢çš„ std::lock_guard æ„é€ éƒ½é¢å¤–ä¼ é€’äº†ä¸€ä¸ª std::adopt_lock å‚æ•°ï¼Œè®©å…¶é€‰æ‹©åˆ°ä¸ä¸Šé”çš„æ„é€ å‡½æ•°ã€‚å‡½æ•°é€€å‡ºä¹Ÿèƒ½æ­£å¸¸è§£é”ã€‚ std::lock ç»™ lhs.m æˆ– rhs.m ä¸Šé”æ—¶è‹¥æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™åœ¨é‡æŠ›å‰å¯¹ä»»ä½•å·²é”çš„å¯¹è±¡è°ƒç”¨ unlock() è§£é”ï¼Œä¹Ÿå°±æ˜¯ std::lock è¦ä¹ˆå°†äº’æ–¥é‡éƒ½ä¸Šé”ï¼Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸é”ã€‚ C++17 æ–°å¢äº† std::scoped_lock ï¼Œæä¾›æ­¤å‡½æ•°çš„ RAII åŒ…è£…ï¼Œé€šå¸¸å®ƒæ¯”è£¸è°ƒç”¨ std::lock æ›´å¥½ã€‚ æ‰€ä»¥æˆ‘ä»¬å‰é¢çš„ä»£ç å¯ä»¥æ”¹å†™ä¸ºï¼š void swap(X\u0026 lhs, X\u0026 rhs) { if (\u0026lhs == \u0026rhs) return; std::scoped_lock guard{ lhs.m,rhs.m }; swap(lhs.object, rhs.object); } ä½¿ç”¨ std::scoped_lock å¯ä»¥å°†æ‰€æœ‰ std::lock æ›¿æ¢æ‰ï¼Œå‡å°‘é”™è¯¯å‘ç”Ÿã€‚ä¹Ÿå¯ä»¥ç”¨ std::unique_lockï¼ˆå¯ä»¥ç®€å•ç†è§£ä¸º std::lock_guard çš„å‡çº§ç‰ˆï¼Œå…·æœ‰é¢å¤–çš„åŠŸèƒ½ï¼Œä¸ºæ›´å¤æ‚çš„é”åšå‡†å¤‡ï¼‰ï¼Œè¯¦æƒ…è§æ ‡å‡†åº“æ–‡æ¡£ã€‚ æ€»ç»“ï¼Œé¿å…æ­»é”è¦æ³¨æ„ï¼š é¿å…åµŒå¥—é”ï¼šçº¿ç¨‹è·å–ä¸€ä¸ªé”æ—¶ï¼Œå°±åˆ«å†è·å–ç¬¬äºŒä¸ªé”ã€‚æ¯ä¸ªçº¿ç¨‹åªæŒæœ‰ä¸€ä¸ªé”ï¼Œè‡ªç„¶ä¸ä¼šäº§ç”Ÿæ­»é”ã€‚å¦‚æœå¿…é¡»è¦è·å–å¤šä¸ªé”ï¼Œä½¿ç”¨ std::lockã€‚ é¿å…åœ¨æŒæœ‰é”æ—¶è°ƒç”¨å¤–éƒ¨ä»£ç  ä½¿ç”¨å›ºå®šé¡ºåºè·å–é” ","date":"2025-03-23","objectID":"/2025/acc27a1/:5:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"è¯»å†™é” å¦‚æœéœ€è¦å¤šçº¿ç¨‹è¯»å–å†™ï¼ˆå¤šçº¿ç¨‹è¯»ä¸å­˜åœ¨æ•°æ®ç«äº‰ï¼›è€Œå†™å’Œè¯»å…±å­˜æ—¶å­˜åœ¨ç«äº‰ï¼‰ï¼Œä½¿ç”¨ std::mutex å¼€é”€è¾ƒå¤§ã€‚è¿™æ—¶å¯ä»¥ç”¨ä¸“é—¨çš„è¯»å†™é”ï¼Œå³ std::shared_timed_mutex (C++ 14)ï¼Œstd::shared_mutex (C++ 17)ã€‚ç¤ºä¾‹ä»£ç ï¼š class Settings { private: std::map\u003cstd::string, std::string\u003e data_; mutable std::shared_mutex mutex_; // â€œM\u0026M è§„åˆ™â€ï¼šmutable ä¸ mutex ä¸€èµ·å‡ºç° public: void set(const std::string\u0026 key, const std::string\u0026 value) { std::lock_guard\u003cstd::shared_mutex\u003e lock{ mutex_ }; data_[key] = value; } std::string get(const std::string\u0026 key) const { std::shared_lock\u003cstd::shared_mutex\u003e lock(mutex_); auto it = data_.find(key); return (it != data_.end()) ? it-\u003esecond : \"\"; // å¦‚æœæ²¡æœ‰æ‰¾åˆ°é”®è¿”å›ç©ºå­—ç¬¦ä¸² } }; ","date":"2025-03-23","objectID":"/2025/acc27a1/:6:0","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"ä½¿ç”¨äº’æ–¥é‡å®ç°å¹¶å‘è¯»å†™é”ï¼ˆå­—èŠ‚ DataAML ä¸€é¢æ‰‹æ’•é¢˜ï¼‰ æˆ‘ä»¬çŸ¥é“ï¼Œå†™æ“ä½œæ˜¯ç‹¬å çš„ï¼›è€Œè¯»æ“ä½œæ˜¯éç‹¬å çš„ï¼Œå³å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»ã€‚å¦‚æœå¤šçº¿ç¨‹è®¿é—®æŸä¸ªå…±äº«å˜é‡æ—¶ï¼Œæ¯æ¬¡è®¿é—®æ—¶éƒ½åŠ ä¸Šä¸€ä¸ªäº’æ–¥é”ï¼Œè¿™æ ·å¼€é”€ä¼šéå¸¸å¤§ã€‚ æ‰€ä»¥æˆ‘ä»¬æœŸæœ›åœ¨å¤šä¸ªçº¿ç¨‹è¯•å›¾è¯»å–å…±äº«å˜é‡çš„æ—¶å€™ï¼Œå®ƒä»¬å¯ä»¥ç«‹åˆ»è·å–å› ä¸ºè¯»è€ŒåŠ çš„é”ï¼Œè€Œä¸æ˜¯éœ€è¦ç­‰å¾…å‰ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ã€‚å½“ç„¶ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ç”¨å†™é”é”ä½äº†ä¸´ç•ŒåŒºï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹æ— è®ºæ˜¯è¯»è¿˜æ˜¯å†™éƒ½ä¼šå‘ç”Ÿé˜»å¡ã€‚ #include \u003ciostream\u003e #include \u003cmutex\u003e #include \u003cthread\u003e class ReadWriteLock { private: std::mutex readMutex; // ç”¨äºä¿æŠ¤è¯»æ“ä½œè®¡æ•°å™¨çš„äº’æ–¥é‡ std::mutex writeMutex; // ç”¨äºä¿æŠ¤å†™æ“ä½œçš„äº’æ–¥é‡ int readCount = 0; // è®°å½•å½“å‰æ­£åœ¨è¿›è¡Œè¯»æ“ä½œçš„çº¿ç¨‹æ•°é‡ bool writing = false; // è¡¨ç¤ºå½“å‰æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨è¿›è¡Œå†™æ“ä½œ public: void readLock() { // é”å®šè¯»æ“ä½œäº’æ–¥é‡ std::unique_lock\u003cstd::mutex\u003e readLock(readMutex); // å¢åŠ è¯»æ“ä½œè®¡æ•°å™¨ ++ readCount; // ç­‰å¾…æ²¡æœ‰å†™æ“ä½œæ—¶è¿›è¡Œè¯»æ“ä½œ while (writing) { readLock.unlock(); std::this_thread::yield(); // è®©å‡ºCPUï¼Œé¿å…å¿™ç­‰å¾… readLock.lock(); } } void readUnlock() { // é”å®šè¯»æ“ä½œäº’æ–¥é‡å¹¶å‡å°‘è¯»æ“ä½œè®¡æ•°å™¨ std::lock_guard\u003cstd::mutex\u003e readLock(readMutex); -- readCount; } void writeLock() { // é”å®šå†™æ“ä½œäº’æ–¥é‡ std::unique_lock\u003cstd::mutex\u003e writeLock(writeMutex); // ç­‰å¾…æ²¡æœ‰è¯»æ“ä½œå’Œå†™æ“ä½œæ—¶è¿›è¡Œå†™æ“ä½œ while (readCount \u003e 0 || writing) { writeLock.unlock(); std::this_thread::yield(); // è®©å‡ºCPUï¼Œé¿å…å¿™ç­‰å¾… writeLock.lock(); } // æ ‡è®°æ­£åœ¨è¿›è¡Œå†™æ“ä½œ writing = true; } void writeUnlock() { // é”å®šå†™æ“ä½œäº’æ–¥é‡å¹¶æ ‡è®°å†™æ“ä½œå®Œæˆ std::lock_guard\u003cstd::mutex\u003e writeLock(writeMutex); writing = false; } }; // ç¤ºä¾‹ä½¿ç”¨ int sharedData = 0; ReadWriteLock lock; void reader() { lock.readLock(); std::cout \u003c\u003c \"Reading: \" \u003c\u003c sharedData \u003c\u003c std::endl; lock.readUnlock(); } void writer() { lock.writeLock(); ++ sharedData; std::cout \u003c\u003c \"Writing: \" \u003c\u003c sharedData \u003c\u003c std::endl; lock.writeUnlock(); } int main() { std::thread readers[5]; std::thread writers[3]; // åˆ›å»ºå¤šä¸ªè¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹ for (int i = 0; i \u003c 5; ++i) { readers[i] = std::thread(reader); } for (int i = 0; i \u003c 3; ++i) { writers[i] = std::thread(writer); } // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯• for (auto\u0026 reader : readers) { reader.join(); } for (auto\u0026 writer : writers) { writer.join(); } return 0; } è¿™æ®µä»£ç ä¸­ï¼Œé”å®šæ“ä½œç”¨çš„æ˜¯ std::unique_lockï¼Œè€Œè§£é”æ“ä½œç”¨çš„æ˜¯ std::lock_guardã€‚è¿™ä¸¤è€…éƒ½æ˜¯ C++ 11 å¼•å…¥çš„ RAII åŒ…è£…ã€‚æ­£å¦‚ä¸Šé¢æ‰€è¿°ï¼Œunique_lock æ˜¯ lock_guard çš„å‡çº§ç‰ˆ ï¼ˆæ›´çµæ´»ï¼Œå¸¸ä¸æ¡ä»¶å˜é‡çš„ wait()ã€notify_one()ã€notify_all()é…åˆä½¿ç”¨ï¼‰ï¼Œè¿™é‡Œé”å®šæ—¶éœ€è¦è§£é”å’Œé‡æ–°é”å®šäº’æ–¥é‡ã€‚è¿™å¯¹äºéœ€è¦åœ¨ç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶è§£é”äº’æ–¥é‡å¹¶è®©å‡º CPU çš„åœºæ™¯éå¸¸æœ‰ç”¨ã€‚ ","date":"2025-03-23","objectID":"/2025/acc27a1/:6:1","tags":["C++"],"title":"å¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰","uri":"/2025/acc27a1/"},{"categories":["å…«è‚¡"],"content":"ä»‹ç» C++ ä¸­çš„å†…å­˜åˆ†é…ã€ç®¡ç†ä»¥åŠæ™ºèƒ½æŒ‡é’ˆçš„åŸç†åŠä½¿ç”¨ ","date":"2025-03-23","objectID":"/2025/01dc872/:0:0","tags":["C++"],"title":"å†…å­˜åˆ†é…","uri":"/2025/01dc872/"},{"categories":["å…«è‚¡"],"content":"C++ ä¸­å†…å­˜çš„ç®¡ç† ","date":"2025-03-23","objectID":"/2025/01dc872/:1:0","tags":["C++"],"title":"å†…å­˜åˆ†é…","uri":"/2025/01dc872/"},{"categories":["å…«è‚¡"],"content":"ç¨‹åºåœ°å€ç©ºé—´ C++ ä¸­ï¼Œå†…å­˜åˆ†å¸ƒåˆ†ä¸ºäº”å—åŒºåŸŸï¼Œåˆ†åˆ«æ˜¯ï¼šæ ˆï¼›å †ï¼›å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼ˆå­˜æ”¾äº data æ®µå’Œ bss æ®µï¼‰ï¼›å¸¸é‡ï¼›ä»£ç ï¼› ä¸Šå›¾æ˜¯å†…æ ¸å’Œç”¨æˆ·çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒæƒ…å†µï¼Œå…¶ä¸­ï¼Œå±€éƒ¨å˜é‡å’Œå‚æ•°ç­‰éƒ½å­˜æ”¾åœ¨æ ˆä¸­ï¼Œè¿™éƒ¨åˆ†ç©ºé—´ç”±ç³»ç»Ÿè¿›è¡Œç®¡ç†ï¼›è€Œå †ä¸­ç©ºé—´ä¸»è¦æ˜¯ç”¨äºç”¨æˆ·è°ƒç”¨ newæˆ– malloc æ—¶åˆ†é…çš„ç©ºé—´ã€‚è¿™éƒ¨åˆ†åŒºåŸŸç”±ç”¨æˆ·ç®¡ç†ï¼Œå› æ­¤å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼ã€‚ malloc åº•å±‚å®ç°åŸç† step1ï¼šä»å†…å­˜æ± ä¸­åˆ†é…ã€‚è‹¥æ‰€éœ€è¦å†…å­˜ \u003c 128KBï¼Œåˆ™ä»å†…å­˜æ± ä¸­å°è¯•åˆ†é…ã€‚è‹¥æ— ï¼Œåˆ™è¿›è¡Œ brk ç³»ç»Ÿè°ƒç”¨ï¼Œä»å †ä¸Šç”³è¯·å†…å­˜ã€‚ step2ï¼šè‹¥ \u003e 128KBï¼Œä¸çœ‹å†…å­˜æ± ï¼Œç›´æ¥ä½¿ç”¨ mmap ç³»ç»Ÿè°ƒç”¨ï¼Œä»æ–‡ä»¶æ˜ å°„åŒºï¼ˆåŒæ—¶è¿˜å­˜æ”¾åŠ¨æ€åº“ï¼‰ä¸­è·å¾—å†…å­˜ã€‚ è¿™é‡Œæˆ‘è§‰å¾—è¿™ç§è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†æ–¹å¼ç²’åº¦å¤ªç²—ï¼Œä¸è¶³ä»¥è¯´æ˜å…·ä½“æƒ…å†µ ","date":"2025-03-23","objectID":"/2025/01dc872/:1:1","tags":["C++"],"title":"å†…å­˜åˆ†é…","uri":"/2025/01dc872/"},{"categories":["å…«è‚¡"],"content":"æ™ºèƒ½æŒ‡é’ˆ æ™ºèƒ½æŒ‡é’ˆåˆ†ä¸ºä¸‰ç±»ï¼šshared_ptrï¼Œunique_ptrï¼Œweak_ptrï¼ˆc98è¿˜å¼•å…¥äº† auto_ptrï¼Œä½†å·²åœ¨ c++11ä¸­è¢«åºŸå¼ƒï¼‰ unique_ptr unique_ptr è¡¨ç¤ºä¸“å±æ‰€æœ‰æƒï¼Œç”¨ unique_ptr ç®¡ç†çš„å†…å­˜ï¼Œåªèƒ½è¢«ä¸€ä¸ªå¯¹è±¡æŒæœ‰ã€‚æ•…ä¸æ”¯æŒå¤åˆ¶å’Œèµ‹å€¼ã€‚ auto w = std::make_unique\u003cWidget\u003e(); // åœ¨ c++14 ä¸­ï¼Œå¯ä»¥ç”¨ make_unique æ–¹æ³•æ¥æ„é€ ã€‚ auto w2 = w; // ç¼–è¯‘é”™è¯¯ å› æ­¤åªèƒ½é€šè¿‡ç§»åŠ¨æ¥æ›´æ”¹ä¸“å±æ‰€æœ‰æƒï¼š auto w = std::make_unique\u003cWidget\u003e(); auto w2 = std::move(w); // w2 è·å¾—å†…å­˜æ‰€æœ‰æƒï¼Œw æ­¤æ—¶ç­‰äº nullptr ç”¨æ³•ï¼šéœ€è¦å¼•å…¥å¤´æ–‡ä»¶ \u003cmemory\u003eï¼Œå¯ä»¥ä½¿ç”¨å³å€¼æ‹·è´æ„é€ æˆ– make æ–¹æ³•æ¥æ„é€ æŒ‡é’ˆã€‚ unique_ptr\u003cint\u003e p1 = make_unique\u003cint\u003e(100); unique_ptr\u003cstring\u003e ps1(new string(\"good luck\")); é€‚ç”¨åœºæ™¯ å¿˜è®° delete class Box { public: Box() : w(new Widget()) {} ~Box() { // ææ„å‡½æ•°ä¸­å¿˜è®° delete w } private: Widget* w; }; å¼‚å¸¸å®‰å…¨ void process() { Widget* w = new Widget(); w-\u003edo_something(); // å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆ delete w å°†ä¸ä¼šæ‰§è¡Œï¼Œæ­¤æ—¶å°±ä¼šå‘ç”Ÿå†…å­˜æ³„éœ² delete w; // ä¹Ÿå¯ä»¥ç”¨ try...catch å—æ•æ‰å¼‚å¸¸ï¼Œå¹¶åœ¨ catch è¯­å¥ä¸­ deleteï¼Œä½†æ˜¯ä¸å¤ªç¾è§‚ + å®¹æ˜“æ¼å†™ } shared_ptr shared_ptr ä»£è¡¨çš„æ˜¯å…±äº«æ‰€æœ‰æƒï¼Œå³å¤šä¸ª shared_ptr å¯ä»¥å…±äº«åŒä¸€å—å†…å­˜ã€‚shared_ptr å†…éƒ¨æ˜¯åˆ©ç”¨å¼•ç”¨è®¡æ•°æ¥å®ç°å†…å­˜çš„è‡ªåŠ¨ç®¡ç†ï¼Œæ¯å½“å¤åˆ¶ä¸€ä¸ª shared_ptrï¼Œå¼•ç”¨è®¡æ•°ä¼š + 1ã€‚å½“ä¸€ä¸ª shared_ptr ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå¼•ç”¨è®¡æ•°ä¼š - 1ã€‚å½“å¼•ç”¨è®¡æ•°ä¸º 0 çš„æ—¶å€™ï¼Œåˆ™ delete å†…å­˜ã€‚ auto w = std::make_shared\u003cWidget\u003e(); auto w2 = w; cout \u003c\u003c w.use_count() \u003c\u003c endl; // g++ -std=c++11 main main.cc output-\u003e2 åŒæ—¶ï¼Œshared_ptr ä¹Ÿæ”¯æŒç§»åŠ¨ã€‚ä»è¯­ä¹‰ä¸Šæ¥çœ‹ï¼Œç§»åŠ¨æŒ‡çš„æ˜¯æ‰€æœ‰æƒçš„ä¼ é€’ã€‚å¦‚ä¸‹ï¼š auto w = std::make_shared\u003cWidget\u003e(); auto w2 = std::move(w); // æ­¤æ—¶ w ç­‰äº nullptrï¼Œw2.use_count() ç­‰äº 1 æ³¨æ„ shared_ptr æ€§èƒ½å¼€é”€æ›´å¤§ï¼Œå‡ ä¹æ˜¯ unique_ptr çš„ä¸¤å€ï¼ˆå› ä¸ºè¿˜è¦ç»´æŠ¤ä¸€ä¸ªè®¡æ•°ï¼‰ è€ƒè™‘åˆ°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¼•ç”¨è®¡æ•°çš„å¢å‡å¿…é¡»æ˜¯åŸå­æ“ä½œã€‚è€ŒåŸå­æ“ä½œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ¯”éåŸå­æ“ä½œæ…¢ ä½¿ç”¨ç§»åŠ¨ä¼˜åŒ–æ€§èƒ½ï¼Œå°½é‡ä½¿ç”¨ std::move æ¥å°† shared_ptr è½¬ç§»ç»™æ–°å¯¹è±¡ã€‚å› ä¸ºç§»åŠ¨ä¸ç”¨å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œæ€§èƒ½æ›´å¥½ ä½¿ç”¨åœºæ™¯ï¼šé€šå¸¸ç”¨äºæŒ‡å®šï¼Œæœ‰å¯èƒ½å¤šä¸ªå¯¹è±¡åŒæ—¶ç®¡ç†ä¸€ä¸ªå†…å­˜çš„æ—¶å€™ã€‚ weak_ptr weak_ptr æ˜¯ä¸ºäº†è§£å†³ shared_ptr åŒå‘å¼•ç”¨çš„é—®é¢˜ã€‚å³ï¼š class B; struct A { shared_ptr\u003cB\u003e b; }; struct B { shared_ptr\u003cA\u003e a; }; auto pa = make_shared\u003cA\u003e(); auto pb = make_shared\u003cB\u003e(); pa-\u003eb = pb; pb-\u003ea = pa; pa å’Œ pb å­˜åœ¨ç€å¾ªç¯å¼•ç”¨ï¼Œæ ¹æ® shared_ptr å¼•ç”¨è®¡æ•°çš„åŸç†ï¼Œpa å’Œ pb éƒ½æ— æ³•è¢«æ­£å¸¸çš„é‡Šæ”¾ã€‚ å¯¹äºè¿™ç§æƒ…å†µ, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ weak_ptrï¼š class B; struct A { shared_ptr\u003cB\u003e b; }; struct B { weak_ptr\u003cA\u003e a; }; auto pa = make_shared\u003cA\u003e(); auto pb = make_shared\u003cB\u003e(); pa-\u003eb = pb; pb-\u003ea = pa; weak_ptr ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤å¯ä»¥æ‰“ç ´ shared_ptr çš„å¾ªç¯å¼•ç”¨ã€‚ é€šå¸¸åšæ³•æ˜¯ parent ç±»æŒæœ‰ child çš„ shared_ptr, child æŒæœ‰æŒ‡å‘ parent çš„ weak_ptrã€‚è¿™æ ·ä¹Ÿæ›´ç¬¦åˆè¯­ä¹‰ã€‚ ","date":"2025-03-23","objectID":"/2025/01dc872/:1:2","tags":["C++"],"title":"å†…å­˜åˆ†é…","uri":"/2025/01dc872/"},{"categories":["å…«è‚¡"],"content":"å®ç°è¿‡ç¨‹ é‰´äºçœ‹åˆ°é¢ç»ä¸­æœ‰åŒå­¦è¢«é—®åˆ°è¿‡æ™ºèƒ½æŒ‡é’ˆçš„åº•å±‚å®ç°ï¼Œå› æ­¤è¿™é‡Œç»™å‡ºä¸¤ç§æ™ºèƒ½æŒ‡é’ˆï¼ˆweak_ptrç•¥ï¼‰çš„ç®€å•å®ç°æ–¹å¼ã€‚ Tips this æœ¬èº«æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥ç±»å®ä¾‹åŒ–åçš„å¯¹è±¡æœ¬èº«ï¼›*thisè¡¨ç¤ºè§£å¼•ç”¨ï¼ŒC++ä¸­å¯¹ä¸€ä¸ªæŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨ï¼Œå¾—åˆ°çš„æ˜¯å½“å‰å¯¹è±¡çš„å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡æœ¬èº« æ³¨æ„è¿™é‡Œ (*this-\u003e_count) ++ çš„ç”¨æ³• æ³¨æ„è¿™é‡Œ = delete çš„è¯­æ³•ï¼Œç”¨äºæ˜¾ç¤ºåœ°ç¦ç”¨ç‰¹å®šçš„å‡½æ•° shared_ptrï¼š template\u003ctypename T\u003e class shared_ptr { private: T* _ptr; int* _count; // å¼•ç”¨è®¡æ•° public: // æ„é€ å‡½æ•° shared_ptr(T* ptr = nullptr) : _ptr(ptr) { if (_ptr) _count = new int(1); else _count = new int(10); } // æ‹·è´æ„é€  shared_ptr(const shared_ptr\u0026 ptr) { if (this != ptr) { this-\u003e_ptr = ptr._ptr; this-\u003e_count = ptr._count; (*this-\u003e_count) ++ ; } } // é‡è½½operator= shared_ptr\u0026 operator=(const shared_ptr \u0026 ptr) { if (this-\u003e_ptr == ptr._ptr) { return *this; } if (this-\u003e_ptr) { (*this-\u003e_count) -- ; if (*this-\u003e_count == 0) { delete this-\u003e_ptr; delete this-\u003e_count; } } this-\u003e_ptr = ptr._ptr; this-\u003e_count = ptr._count; (*this-\u003e_count) ++ ; return *this; } // operator*é‡è½½ T\u0026 operator*() { if (this-\u003e_ptr) { return *(this-\u003e_ptr); } } // operator-\u003eé‡è½½ T* operator-\u003e() { if (this-\u003e_ptr) { return this-\u003e_ptr; } } // ææ„å‡½æ•° ~shared_ptr() { (*this-\u003e_count) -- ; if (*this-\u003e_count == 0) { delete this-\u003e_ptr; delete this-\u003e_count; } } // è¿”å›å¼•ç”¨è®¡æ•° int use_count() { return *this-\u003e_count; } }; unique_ptrï¼š template\u003ctypename T\u003e class unique_ptr { private: T* _ptr; public: // æ„é€ å‡½æ•° unique_ptr(T* ptr = nullptr) : _ptr(ptr) {} // ææ„å‡½æ•° ~unique_ptr() { del() }; // å…ˆé‡Šæ”¾èµ„æºï¼ˆå¦‚æœæŒæœ‰ï¼‰ï¼Œå†æŒæœ‰èµ„æº void reset(T* ptr) { del(); _ptr = ptr; } // è¿”å›èµ„æºï¼Œèµ„æºçš„é‡Šæ”¾ç”±è°ƒç”¨æ–¹å¤„ç† T* release() { T* ptr = _ptr; _ptr = nullptr; return ptr; } // è·å–èµ„æºï¼Œè°ƒç”¨æ–¹åº”è¯¥åªä½¿ç”¨ä¸é‡Šæ”¾ï¼Œå¦åˆ™ä¼šä¸¤æ¬¡deleteèµ„æº T* get() { return _ptr; } private: // é‡Šæ”¾ void del() { if (_ptr == nullptr) return; delete _ptr; _ptr = nullptr; } // ç¦ç”¨æ‹·è´æ„é€  unique_ptr(const unique_ptr \u0026) = delete; // ç¦ç”¨æ‹·è´èµ‹å€¼ unique_ptr\u0026 operator = (const unique_ptr \u0026) = delete; }; ","date":"2025-03-23","objectID":"/2025/01dc872/:1:3","tags":["C++"],"title":"å†…å­˜åˆ†é…","uri":"/2025/01dc872/"},{"categories":["å…«è‚¡"],"content":"C++å¤šæ€çš„å®ç°æ–¹æ³•åŠåŸç† ","date":"2025-03-23","objectID":"/2025/b97727d/:0:0","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"è™šå‡½æ•° https://zhuanlan.zhihu.com/p/54145222 https://zhuanlan.zhihu.com/p/629281871 ","date":"2025-03-23","objectID":"/2025/b97727d/:1:0","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"æ¦‚å¿µè§£é‡Š ç”¨ä¸€ä¸ªä¾‹å­ç†è§£è™šå‡½æ•°çš„ä½œç”¨ï¼š Animal* catAnimal = \u0026cat Animal\u0026 dogAnimal = dog; catAnimal-\u003espeak() dogAnimal.speak() // è°ƒç”¨çš„è¿˜æ˜¯åŸºç±» Animal æœ¬èº«çš„æ–¹æ³• // ä¸ºä»€ä¹ˆè¦ç”¨åŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨æ¥å®Œæˆï¼ŸåŸºç±»èƒ½å¤ŸåŠ¨æ€ç¡®å®šå…¶å®é™…æ‰€æŒ‡å‘çš„æ´¾ç”Ÿç±»å¯¹è±¡ï¼Œå¹¶è°ƒç”¨åˆé€‚ç‰ˆæœ¬çš„æ–¹æ³•ï¼Œ // é‚£ä¹ˆä¸€ä¸ªå‡½æ•°å°±å¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜ // ç”¨è™šå‡½æ•°æ¥å®Œæˆä¸Šè¿°åŠŸèƒ½ class Animal { public: // ... // virtual string speak() const { return \"???\"; } } class Cat { public: // ... // virtual string speak() const { return \"Meow\"; } } class Dog { public: // ... // virtual string speak() const { return \"Woof\"; } } Animal ç±»è¢« Cat å’Œ Dogç±»ç»§æ‰¿å¹¶è¦†ç›–äº† speak å‡½æ•°ä»¥å®ç°ä¸åŒçš„è¡Œä¸ºã€‚å½“ä½¿ç”¨ Animalçš„æŒ‡é’ˆæˆ–å¼•ç”¨æ¥è°ƒç”¨ speak å‡½æ•°æ—¶ï¼Œä¼šæ ¹æ®è¿è¡Œæ—¶çš„å¯¹è±¡ç±»å‹æ¥åŠ¨æ€åœ°å†³å®šè°ƒç”¨å“ªä¸ªå­ç±»çš„å‡½æ•°ï¼Œä»è€Œå®ç°å¤šæ€æ€§ã€‚ ","date":"2025-03-23","objectID":"/2025/b97727d/:1:1","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"å®ç°åŸç† C++ ä¸­ï¼Œè™šå‡½æ•°çš„å®ç°åŸç†åŸºäºä¸¤ä¸ªæ¦‚å¿µï¼šè™šå‡½æ•°è¡¨å’Œè™šå‡½æ•°æŒ‡é’ˆã€‚ è™šå‡½æ•°è¡¨ æ¯ä¸ªåŒ…å«è™šå‡½æ•°çš„ç±»ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼ˆVirtual Tableï¼‰ï¼Œå­˜å‚¨ç€è¯¥ç±»ä¸­æ‰€æœ‰çš„è™šå‡½æ•°çš„åœ°å€ã€‚è™šå‡½æ•°è¡¨æ˜¯ä¸€ä¸ªç”±æŒ‡é’ˆæ„æˆçš„æ•°ç»„ï¼Œæ¯ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªè™šå‡½æ•°çš„å®ç°ä»£ç ã€‚ è™šå‡½æ•°æŒ‡é’ˆ åœ¨å¯¹è±¡å†…å­˜å¸ƒå±€ä¸­ï¼Œç¼–è¯‘å™¨ä¼šæ·»åŠ ä¸€ä¸ªé¢å¤–çš„æŒ‡é’ˆï¼Œç§°ä¸ºè™šå‡½æ•°æŒ‡é’ˆæˆ–è™šè¡¨æŒ‡é’ˆï¼ˆVirtual Table Pointerï¼Œa.k.a VTableæŒ‡é’ˆï¼‰ã€‚è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘è¯¥å¯¹è±¡å¯¹åº”çš„è™šå‡½æ•°è¡¨ï¼Œä»è€Œè®©ç¨‹åºèƒ½å¤ŸåŠ¨æ€åœ°è°ƒç”¨æ­£ç¡®çš„è™šå‡½æ•°ã€‚ è™šå‡½æ•°æŒ‡é’ˆå¯ä»¥ç±»æ¯”æ“ä½œç³»ç»Ÿä¸­ï¼Œè™šæ‹Ÿå†…å­˜æ˜ å°„ä¸­çš„é¡µè¡¨åŸºå€ï¼Œå­˜å‚¨åœ¨é¡µè¡¨åŸºå€å¯„å­˜å™¨ï¼ˆxv6 æ˜¯ satp å¯„å­˜å™¨ï¼‰ä¸­ï¼Œæœ‰äº†é¡µè¡¨åŸºå€ï¼Œå°±å¯ä»¥æ‰¾åˆ°ä¸€çº§é¡µè¡¨ï¼Œä»è€Œæ‰¾åˆ°äºŒçº§é¡µè¡¨ï¼Œè¿›è€Œæ‰¾åˆ°ç‰©ç†åœ°å€ã€‚ å½“ä¸€ä¸ªåŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨è™šè¡¨æŒ‡é’ˆæ¥æŸ¥æ‰¾è¯¥å¯¹è±¡å¯¹åº”çš„è™šå‡½æ•°è¡¨ï¼Œå¹¶æ ¹æ®å‡½æ•°åœ¨è™šå‡½æ•°è¡¨ä¸­çš„ä½ç½®æ¥è°ƒç”¨æ­£ç¡®çš„è™šå‡½æ•°ã€‚ä½†åŒæ—¶ç”±äºè™šå‡½æ•°è¡¨çš„å­˜åœ¨ï¼Œå¯¼è‡´éœ€è¦é¢å¤–çš„å­˜å‚¨ç©ºé—´æ¥å­˜å‚¨è™šå‡½æ•°è¡¨åŠå…¶æŒ‡é’ˆï¼Œå¯¼è‡´ C++ åœ¨è°ƒç”¨è™šå‡½æ•°æ—¶æ¯”å…¶ä»–è¯­è¨€æˆæœ¬è¦é«˜ã€‚ è™šå‡½æ•°æŒ‡é’ˆæ˜¯å®ç°å¤šçº§ç»§æ‰¿çš„å…³é”®ï¼Œåœ¨å¤šçº§ç»§æ‰¿ä¸­ï¼Œæ¯ä¸ªå­ç±»éƒ½éœ€è¦ç»´æŠ¤è‡ªå·±çš„è™šå‡½æ•°è¡¨åŠå…¶è™šå‡½æ•°æŒ‡é’ˆ è™šå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ åœ¨ç¼–è¯‘æœŸé—´ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®å‡½æ•°è°ƒç”¨çš„ç±»å‹å’Œå¯¹è±¡çš„ç±»å‹ç¡®å®šè¦è°ƒç”¨çš„å‡½æ•°ã€‚ åœ¨è¿è¡ŒæœŸé—´ï¼Œç¨‹åºä¼šæ ¹æ®å¯¹è±¡çš„å®é™…ç±»å‹æ¥å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚è¿™ä¸ªè¿‡ç¨‹å«åšåŠ¨æ€ç»‘å®šæˆ–è€…åæœŸç»‘å®šã€‚ ç¨‹åºé€šè¿‡è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰æ¥å®ç°åŠ¨æ€ç»‘å®šã€‚æ¯ä¸ªå«æœ‰è™šå‡½æ•°çš„ç±»éƒ½æœ‰è‡ªå·±çš„è™šå‡½æ•°è¡¨ï¼Œå­˜å‚¨äº†æŒ‡å‘å®é™…å‡½æ•°åœ°å€çš„æŒ‡é’ˆã€‚åœ¨å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå®ƒçš„æŒ‡é’ˆä¼šæŒ‡å‘æ‰€å±ç±»çš„è™šå‡½æ•°è¡¨ã€‚ å½“è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œåœ¨å¯¹è±¡ä¸­å­˜å‚¨çš„æŒ‡é’ˆä¼šè¢«è§£å¼•ç”¨ï¼Œè·å–åˆ°è™šå‡½æ•°è¡¨çš„åœ°å€ã€‚ç„¶åæ ¹æ®å‡½æ•°è°ƒç”¨çš„ç±»å‹ï¼Œä»è™šå‡½æ•°è¡¨ä¸­è·å–ç›¸åº”çš„å‡½æ•°åœ°å€ã€‚ æœ€åï¼Œç¨‹åºè·³è½¬åˆ°å‡½æ•°åœ°å€å¤„æ‰§è¡Œå®é™…çš„ä»£ç ã€‚ç”±äºæ˜¯åŠ¨æ€ç»‘å®šï¼Œæ‰€ä»¥è°ƒç”¨çš„å‡½æ•°æ˜¯æ ¹æ®å¯¹è±¡å®é™…ç±»å‹æ¥å†³å®šçš„ã€‚ ","date":"2025-03-23","objectID":"/2025/b97727d/:1:2","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"è™šå‡½æ•°çš„ä½¿ç”¨ åœ¨ C++ ä¸­ï¼Œæ´¾ç”Ÿç±»å¯ä»¥é‡å†™ (override) å®ƒç»§æ‰¿çš„è™šå‡½æ•°ï¼Œè¿™è¢«ç§°ä¸ºå‡½æ•°çš„è¦†ç›– (overriding)ã€‚å½“ç„¶ï¼Œå­ç±»ä¹Ÿå¯ä»¥é€‰æ‹©ä¸é‡å†™åŸºç±»çš„è™šå‡½æ•°ï¼Œé‚£ä¹ˆå®ƒå°†é»˜è®¤ç»§æ‰¿åŸºç±»çš„å®ç°ï¼Œè¿™å°±æ˜¯è™šå‡½æ•°çš„é‡è½½ (overloading)ã€‚ class Base { public: virtual void foo() { std::cout \u003c\u003c \"Base::foo()\" \u003c\u003c std::endl; } }; class Derived : public Base { public: void foo() { std::cout \u003c\u003c \"Derived::foo()\" \u003c\u003c std::endl; } }; int main() { Derived obj; Base* ptr = \u0026obj; ptr-\u003efoo(); // è¾“å‡ºï¼šDerived::foo() return 0; } å¯ä»¥çœ‹åˆ°ï¼Œä¸è®ºæ˜¯åŸºç±»ç‰ˆæœ¬è¿˜æ˜¯æ´¾ç”Ÿç±»ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éƒ½åœ¨å‡½æ•°å‰é¢ä½¿ç”¨äº† virtual å…³é”®å­—ï¼Œäº‹å®ä¸Šï¼Œæ´¾ç”Ÿç±»ä¸­çš„ virtual å…³é”®å­—å¹¶ä¸æ˜¯å¿…è¦çš„ã€‚ä¸€æ—¦åŸºç±»ä¸­çš„æ–¹æ³•æ‰“ä¸Šäº† virtual æ ‡ç­¾ï¼Œé‚£ä¹ˆæ´¾ç”Ÿç±»ä¸­åŒ¹é…çš„å‡½æ•°ä¹Ÿæ˜¯è™šå‡½æ•°ã€‚ä½†æ˜¯ï¼Œè¿˜æ˜¯å»ºè®®åœ¨åé¢çš„æ´¾ç”Ÿç±»ä¸­åŠ ä¸Š virtual å…³é”®å­—ï¼Œä½œä¸ºè™šå‡½æ•°çš„ä¸€ç§æé†’ï¼Œä»¥ä¾¿åé¢å¯èƒ½è¿˜ä¼šæœ‰æ›´è¿œçš„æ´¾ç”Ÿã€‚ å­ç±»ä¸­é‡å†™è™šå‡½æ•°æ—¶ï¼Œè®¿é—®æƒé™ä¸èƒ½æ›´ä¸¥æ ¼ï¼ˆå³ä¸èƒ½ç”± public å˜ä¸º private æˆ– protectedï¼‰ï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼› è™šå‡½æ•°çš„è¦†ç›–å®é™…ä¸Šæ˜¯é€šè¿‡æŒ‡å®š override å…³é”®å­—æ˜¾ç¤ºå£°æ˜æ¥å®ç°çš„ã€‚ä¾‹å¦‚ï¼š class Base { public: virtual void foo() { std::cout \u003c\u003c \"Base::foo()\" \u003c\u003c std::endl; } }; class Derived : public Base { public: void foo() override { std::cout \u003c\u003c \"Derived::foo()\" \u003c\u003c std::endl; } }; int main() { Derived obj; Base* ptr = \u0026obj; ptr-\u003efoo(); // è¾“å‡ºï¼šDerived::foo() return 0; } è¿›ä¸€æ­¥åœ°ï¼Œä¸€èˆ¬æ¥è¯´æ´¾ç”Ÿç±»éœ€è¦é‡å†™åŸºç±»çš„æ–¹æ³•ï¼Œä»¥ä¾¿äºç”¨åŸºç±»æŒ‡é’ˆåŠ¨æ€è°ƒç”¨ä¸åŒæ´¾ç”Ÿç±»çš„æˆå‘˜æ–¹æ³•ï¼Œä½†æ˜¯ä¸€æ—¦å‡½æ•°ç­¾åä¸åŒï¼Œå°±ä¼šå¯¼è‡´é‡å†™å¤±è´¥ã€‚ä¸ºäº†é¿å…å¯èƒ½å‘ç”Ÿçš„å°é”™è¯¯å¯¼è‡´é‡å†™å¤±è´¥æ— æ³•è°ƒç”¨æ´¾ç”Ÿç±»çš„æˆå‘˜æ–¹æ³•ï¼Œéœ€è¦åœ¨æ´¾ç”Ÿç±»çš„æˆå‘˜æ–¹æ³•åæ·»åŠ  overrideï¼š class Super { public: virtual string getName1(int x) { return \"Super\"; } virtual string getName2(int x) { return \"Super\"; } }; class Sub: public Super{ public: virtual string getName1(double x) override { return \"Sub\"; } virtual string getName2(int x) const override { return \"Sub\"; }// æ­¤æ—¶æ— æ³•ç¼–è¯‘ }; ","date":"2025-03-23","objectID":"/2025/b97727d/:1:3","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"çº¯è™šå‡½æ•° çº¯è™šå‡½æ•°æ˜¯æŒ‡åœ¨åŸºç±»ä¸­å®šä¹‰çš„ï¼Œæ²¡æœ‰å®ç°çš„è™šå‡½æ•°ã€‚è¿™é‡Œçš„ â€œ=0â€ è¡¨ç¤ºè¯¥å‡½æ•°ä¸ºè™šå‡½æ•°ã€‚ virtual void func() = 0; çº¯è™šå‡½æ•°çš„ä½œç”¨æ˜¯è®©å­ç±»å¿…é¡»å®ç°è¯¥å‡½æ•°ï¼Œå¹¶ä¸”ä¸èƒ½ç›´æ¥åˆ›å»ºè¯¥ç±»çš„å¯¹è±¡ï¼ˆå³è¯¥ç±»ä¸ºæŠ½è±¡ç±»ï¼‰ã€‚ æŠ½è±¡ç±»æ˜¯åŒ…å«çº¯è™šå‡½æ•°çš„ç±»ï¼Œå®ƒä»¬ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œåªèƒ½è¢«ç»§æ‰¿ã€‚ æŠ½è±¡ç±»åªèƒ½ç”¨ä½œå…¶ä»–ç±»çš„åŸºç±»ã€‚å¦‚æœä¸€ä¸ªç±»ç»§æ‰¿äº†æŠ½è±¡ç±»ï¼Œåˆ™å¿…é¡»å®ç°æ‰€æœ‰çš„çº¯è™šå‡½æ•°ï¼Œå¦åˆ™è¯¥ç±»ä¹Ÿä¼šæˆä¸ºæŠ½è±¡ç±»ã€‚ ç¤ºä¾‹ä»£ç ï¼š class Shape{ public: // çº¯è™šå‡½æ•° virtual double getArea() = 0; }; // ç»§æ‰¿è‡ªæŠ½è±¡ç±»Shape class Rectangle: public Shape { public: double width; double height; double getArea() {return width * height;} }; // ç»§æ‰¿è‡ªæŠ½è±¡ç±»Shape class Circle: public Shape { public: double radius; double getArea() {return 3.14*radius*radius;} }; ","date":"2025-03-23","objectID":"/2025/b97727d/:2:0","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"åŠ¨æ€ç»‘å®šä¸é™æ€ç»‘å®š é€šè¿‡ä»¥ä¸Šæè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥è™šå‡½æ•°å¯ä»¥ç”¨æ¥è¿›è¡ŒåŠ¨æ€ç»‘å®šï¼ˆåŒºåˆ†äºé™æ€ç»‘å®šï¼‰ã€‚ // é™æ€ç»‘å®šç¤ºä¾‹ class Shape { public: void draw() { cout \u003c\u003c \"Drawing a shape.\" \u003c\u003c endl; } }; class Circle : public Shape { public: void draw() { cout \u003c\u003c \"Drawing a circle.\" \u003c\u003c endl; } }; int main() { Shape* shapeObj = new Circle(); shapeObj-\u003edraw(); // ç¼–è¯‘æ—¶æœŸç¡®å®šæ–¹æ³•è°ƒç”¨ï¼Œè¾“å‡º \"Drawing a shape.\" } // åŠ¨æ€ç»‘å®šç¤ºä¾‹ class Shape { public: virtual void draw() { cout \u003c\u003c \"Drawing a shape.\" \u003c\u003c endl; } }; class Circle : public Shape { public: void draw() { cout \u003c\u003c \"Drawing a circle.\" \u003c\u003c endl; } }; int main() { Shape* shapeObj = new Circle(); shapeObj-\u003edraw(); // è¿è¡Œæ—¶æœŸç¡®å®šæ–¹æ³•è°ƒç”¨ï¼Œè¾“å‡º \"Drawing a circle.\" } ","date":"2025-03-23","objectID":"/2025/b97727d/:3:0","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"é™æ€å¤šæ€ä¸åŠ¨æ€å¤šæ€ é™æ€å¤šæ€ï¼ˆä¹Ÿç§°ä¸ºç¼–è¯‘æ—¶å¤šæ€ï¼‰æ˜¯æŒ‡åœ¨ç¼–è¯‘æ—¶å°±èƒ½å¤Ÿç¡®å®šå‡½æ•°æˆ–æ–¹æ³•çš„è°ƒç”¨å¯¹è±¡ï¼Œå³å‡½æ•°æˆ–æ–¹æ³•çš„é‡è½½ã€‚åœ¨é™æ€å¤šæ€ä¸­ï¼Œå‡½æ•°æˆ–æ–¹æ³•çš„é‡è½½æ˜¯é€šè¿‡å‚æ•°ç±»å‹ã€å‚æ•°æ•°é‡æˆ–å‚æ•°é¡ºåºæ¥åŒºåˆ†çš„ã€‚ int add(int a, int b){ return a + b; } double add(double a, double b){ return a + b; } å½“è°ƒç”¨ add() æ–¹æ³•æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®ä¼ é€’ç»™æ–¹æ³•çš„å‚æ•°ç±»å‹æ¥å†³å®šä½¿ç”¨å“ªä¸ªé‡è½½ç‰ˆæœ¬ã€‚ åŠ¨æ€å¤šæ€ï¼ˆä¹Ÿç§°ä¸ºè¿è¡Œæ—¶å¤šæ€ï¼‰æ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰èƒ½ç¡®å®šå‡½æ•°æˆ–æ–¹æ³•çš„è°ƒç”¨å¯¹è±¡ï¼Œå³è™šå‡½æ•°æˆ–æŠ½è±¡ç±»ã€‚åœ¨åŠ¨æ€å¤šæ€ä¸­ï¼Œå‡½æ•°æˆ–æ–¹æ³•çš„é‡è½½æ˜¯é€šè¿‡ç»§æ‰¿å’Œå¤šæ€æ¥å®ç°çš„ã€‚è§ä¸Šé¢çš„è™šå‡½æ•°ä»£ç æ ·ä¾‹ã€‚ ","date":"2025-03-23","objectID":"/2025/b97727d/:4:0","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"ä¸€äº›å¸¸è§é—®é¢˜ ","date":"2025-03-23","objectID":"/2025/b97727d/:5:0","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"è™šææ„å‡½æ•° æˆ‘ä»¬çŸ¥é“ææ„å‡½æ•°å­˜åœ¨çš„å¿…è¦æ€§ä¹‹ä¸€å°±æ˜¯ï¼Œå¦‚æœç±»å†…æœ‰æŒ‡é’ˆç±»å‹å˜é‡ï¼Œéœ€è¦åœ¨ææ„å‡½æ•°ä¸­è¿›è¡Œæ‰‹åŠ¨é‡Šæ”¾ï¼ˆdelete ptrï¼‰ã€‚ä½†æ˜¯å¦‚æœç”¨åŸºç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡ï¼Œå½“å­ç±»å®ä¾‹è¢«åˆ é™¤æ—¶ï¼Œåªä¼šè°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ï¼Œè€Œä¸ä¼šè°ƒç”¨å­ç±»çš„ææ„å‡½æ•°ï¼Œä»è€Œä½¿å¾—å­ç±»ä¸­åŠ¨æ€åˆ†é…çš„å†…å­˜æ— æ³•è¢«é‡Šæ”¾é€ æˆå†…å­˜æ³„æ¼ã€‚è¿™ä¸ªæ—¶å€™éœ€è¦ä½¿ç”¨è™šææ„å‡½æ•°æ¥é‡Šæ”¾å†…å­˜ã€‚ ","date":"2025-03-23","objectID":"/2025/b97727d/:5:1","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"è™šå‡½æ•°çš„æ€§èƒ½å½±å“ æ ¹æ®ä¸Šé¢æ‰€è¿°ï¼Œä½¿ç”¨è™šå‡½æ•°èƒ½å¤Ÿè¾¾åˆ°åŠ¨æ€ç»‘å®šçš„ç›®çš„ï¼Œè¿™åŒæ—¶ä¼šå¢åŠ ä¸€äº›å¼€é”€ï¼Œé™ä½æ‰§è¡Œæ•ˆç‡ã€‚ä½†æ˜¯ç°ä»£ç¼–è¯‘å™¨èƒ½å¤Ÿå°†å¼€é”€ä¼˜åŒ–è‡³å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ ","date":"2025-03-23","objectID":"/2025/b97727d/:5:2","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["å…«è‚¡"],"content":"å¤šé‡ç»§æ‰¿ä¸­çš„è™šå‡½æ•° class Base1 { public: virtual void func() { cout \u003c\u003c \"Base1::func()\" \u003c\u003c endl; } }; class Base2 { public: virtual void func() { cout \u003c\u003c \"Base2::func()\" \u003c\u003c endl; } }; class Derived : public Base1, public Base2 { public: virtual void func() { Base1::func(); Base2::func(); } }; ä¸€ä¸ªç±»åŒæ—¶ç»§æ‰¿å¤šä¸ªåŸºç±»ï¼Œå¹¶ä¸”è¿™äº›åŸºç±»ä¸­æœ‰å¤šä¸ªåŒåè™šå‡½æ•°ï¼Œé‚£ä¹ˆå­ç±»ä¸­å¿…é¡»å¯¹è¿™äº›è™šå‡½æ•°è¿›è¡Œé‡å†™ã€‚ æˆ‘ç†è§£æ˜¯ï¼Œå¦‚æœæ˜¯å•ç»§æ‰¿ï¼Œé‚£ä¹ˆå¯ä»¥é‡å†™ä¹Ÿå¯ä»¥ä¸é‡å†™ï¼Œä¸é‡å†™ç›¸å½“äºå°±æ˜¯ç»§æ‰¿åŸºç±»çš„å®ç°ï¼›è€Œå¤šç»§æ‰¿ä¸­ä¸ºäº†é¿å…æœªçŸ¥çš„é”™è¯¯ï¼Œå¿…é¡»å¯¹æ¯ä¸ªåŸºç±»è™šå‡½æ•°è¿›è¡Œé‡å†™ã€‚ ","date":"2025-03-23","objectID":"/2025/b97727d/:5:3","tags":["C++"],"title":"è™šå‡½æ•°ä¸å¤šæ€","uri":"/2025/b97727d/"},{"categories":["ç®—æ³•"],"content":"ç”± randA() å®ç° randB()ï¼šä¸‡èƒ½æ„é€ æ³• randA() æ„é€  randB() æ—¶ï¼Œéœ€è¦æ‰¾ä¸€ä¸ªæœ€å¤§è´¨å› å­ä¸è¶…è¿‡ A çš„æ•° n (n\u003e=Bï¼‰ï¼Œç„¶åå¯¹ n åˆ†è§£è´¨å› å­å°±èƒ½æ‰¾åˆ°æ¯ä¸ªé‡‡æ ·éœ€è¦å–å¤šå°‘ç§ç»“æœã€‚å®é™…åˆ°å…·ä½“æ•°å­—æ—¶ï¼Œå¯ä»¥æŠŠéƒ¨åˆ†è´¨å› å­åˆå¹¶æˆä¸è¶…è¿‡ A çš„æ•°ï¼Œä»è€Œå‡å°‘é‡‡æ ·æ¬¡æ•°ã€‚ ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼Œå¦‚ä½•ç”¨ rand7() æ¥æ„é€  rand10() ","date":"2025-03-22","objectID":"/2025/b44918a/:0:0","tags":["æ„é€ "],"title":"æ„é€  RandX()","uri":"/2025/b44918a/"},{"categories":["ç®—æ³•"],"content":"ç¡®å®šé‡‡æ ·å‚æ•° æ­¥éª¤ 1ï¼šé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ•° n æˆ‘ä»¬é€‰æ‹© n = 30ï¼Œå› ä¸ºå®ƒå¤§äºæˆ–ç­‰äº 10ï¼Œå¹¶ä¸”å®ƒçš„æœ€å¤§è´¨å› å­æ˜¯ 5ï¼Œä¸è¶…è¿‡ 7ã€‚ æ­¥éª¤ 2ï¼šå¯¹ n è¿›è¡Œè´¨å› å­åˆ†è§£ å°† 30 åˆ†è§£ä¸ºè´¨å› å­çš„ä¹˜ç§¯å½¢å¼ï¼š $$ 30 = 21 \\times 31 \\times 5^1 $$ æ­¥éª¤ 3ï¼šç¡®å®šé‡‡æ ·æ¬¡æ•°å’Œç»“æœæ•°é‡ æ ¹æ®è´¨å› å­åˆ†è§£çš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œ 3 æ¬¡é‡‡æ ·ï¼Œæ¯æ¬¡é‡‡æ ·çš„ç»“æœæ•°é‡åˆ†åˆ«ä¸º 2ã€3 å’Œ 5ã€‚ï¼ˆåˆ†åˆ«å¯¹åº”ä¸‰ä¸ªè´¨å› å­ï¼‰ ","date":"2025-03-22","objectID":"/2025/b44918a/:1:0","tags":["æ„é€ "],"title":"æ„é€  RandX()","uri":"/2025/b44918a/"},{"categories":["ç®—æ³•"],"content":"è¿›è¡Œé‡‡æ · æˆ‘ä»¬å°†è¿›è¡Œ 3 æ¬¡é‡‡æ ·ï¼Œæ¯æ¬¡é‡‡æ ·ä½¿ç”¨ rand7() å‡½æ•°æ¥ç”Ÿæˆä¸€ä¸ªä»‹äº 1 å’Œ 7 ä¹‹é—´çš„éšæœºæ•°ã€‚ ç¬¬ä¸€æ¬¡é‡‡æ · ä½¿ç”¨ rand7() æ¥ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œå¦‚æœç»“æœåœ¨ [1, 2] èŒƒå›´å†…ï¼Œåˆ™å°†å…¶ä½œä¸ºç¬¬ä¸€æ¬¡é‡‡æ ·çš„ç»“æœã€‚å¦åˆ™ï¼Œé‡æ–°é‡‡æ ·ã€‚ int first; while (true) { first = rand7(); if (first \u003c= 2) break; } ç¬¬äºŒæ¬¡é‡‡æ · ä½¿ç”¨ rand7() æ¥ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œå¦‚æœç»“æœåœ¨ [1, 3] èŒƒå›´å†…ï¼Œåˆ™å°†å…¶ä½œä¸ºç¬¬ä¸€æ¬¡é‡‡æ ·çš„ç»“æœã€‚å¦åˆ™ï¼Œé‡æ–°é‡‡æ ·ã€‚ int second; while (true) { second = rand7(); if (second \u003c= 3) break; } ç¬¬ä¸‰æ¬¡é‡‡æ · ä½¿ç”¨ rand7() æ¥ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œå¦‚æœç»“æœåœ¨ [1, 5] èŒƒå›´å†…ï¼Œåˆ™å°†å…¶ä½œä¸ºç¬¬ä¸€æ¬¡é‡‡æ ·çš„ç»“æœã€‚å¦åˆ™ï¼Œé‡æ–°é‡‡æ ·ã€‚ int third; while (true) { third = rand7(); if (third \u003c= 5) break; } ","date":"2025-03-22","objectID":"/2025/b44918a/:2:0","tags":["æ„é€ "],"title":"æ„é€  RandX()","uri":"/2025/b44918a/"},{"categories":["ç®—æ³•"],"content":"ç»„åˆç»“æœ å°†æ¯æ¬¡é‡‡æ ·çš„ç»“æœç»„åˆèµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªé•¿åº¦ä¸º 30 çš„åºåˆ—ã€‚å…·ä½“æ¥è¯´ï¼š first çš„å–å€¼èŒƒå›´æ˜¯ [1, 2]ï¼Œæ€»å…±æœ‰ 2 ç§å¯èƒ½ã€‚ second çš„å–å€¼èŒƒå›´æ˜¯ [1, 3]ï¼Œæ€»å…±æœ‰ 3 ç§å¯èƒ½ã€‚ third çš„å–å€¼èŒƒå›´æ˜¯ [1, 5]ï¼Œæ€»å…±æœ‰ 5 ç§å¯èƒ½ã€‚ æˆ‘ä»¬é€šè¿‡ä¸‰æ¬¡é‡‡æ ·å¾—åˆ°ä¸‰ä¸ªå€¼ï¼šfirstã€second å’Œ thirdã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†è¿™ä¸‰ä¸ªå€¼ç»„åˆæˆä¸€ä¸ªå”¯ä¸€çš„ç´¢å¼•ï¼Œè¿™ä¸ªç´¢å¼•åº”è¯¥å¯¹åº”äºä¸€ä¸ªé•¿åº¦ä¸º 30 çš„åºåˆ—ä¸­çš„ä¸€ä¸ªä½ç½®ã€‚ è¿™ä¸‰ä¸ªå€¼çš„æ‰€æœ‰å¯èƒ½ç»„åˆæ•°æ˜¯ï¼š$ 2\\times 3\\times 5 = 30 $ï¼Œ è¿™æ­£å¥½ç­‰äºæˆ‘ä»¬é¢„å®šä¹‰çš„åºåˆ—é•¿åº¦ã€‚ ","date":"2025-03-22","objectID":"/2025/b44918a/:3:0","tags":["æ„é€ "],"title":"æ„é€  RandX()","uri":"/2025/b44918a/"},{"categories":["ç®—æ³•"],"content":"æ˜ å°„ ä¸ºäº†å°†è¿™ä¸‰ä¸ªå€¼ç»„åˆæˆä¸€ä¸ªå”¯ä¸€çš„ç´¢å¼•ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªå€¼åˆ†é…ä¸€ä¸ªæƒé‡ï¼Œä½¿å¾—å®ƒä»¬çš„ç»„åˆèƒ½å¤Ÿè¦†ç›–ä» 1 åˆ° 30 çš„æ‰€æœ‰æ•´æ•°ã€‚ å…¬å¼ä¸ºï¼š $$ index = (first - 1)\\times 3 \\times 5 + (second - 1)\\times 5 + (third - 1) + 1 $$ ä»£è¡¨ï¼š $$[0, 1]\\times 3\\times 5 \\rightarrow [0, 15]$$ $$[0, 2]\\times 5 \\rightarrow [0, 10]$$ $$[0, 4] + 1 \\rightarrow [1, 5]$$ ","date":"2025-03-22","objectID":"/2025/b44918a/:4:0","tags":["æ„é€ "],"title":"æ„é€  RandX()","uri":"/2025/b44918a/"},{"categories":["ç®—æ³•"],"content":"å®Œæ•´ä»£ç  int rand10() { int first, second, third; while (true) { first = rand7(); // ç¬¬ä¸€æ¬¡é‡‡æ · if (first \u003c= 2) break; // å¦‚æœç»“æœåœ¨ [1, 2] èŒƒå›´å†…ï¼Œåˆ™é€€å‡ºå¾ªç¯ } while (true) { second = rand7(); // ç¬¬äºŒæ¬¡é‡‡æ · if (second \u003c= 3) break; // å¦‚æœç»“æœåœ¨ [1, 3] èŒƒå›´å†…ï¼Œåˆ™é€€å‡ºå¾ªç¯ } while (true) { third = rand7(); // ç¬¬ä¸‰æ¬¡é‡‡æ · if (third \u003c= 5) break; // å¦‚æœç»“æœåœ¨ [1, 5] èŒƒå›´å†…ï¼Œåˆ™é€€å‡ºå¾ªç¯ } // å°†ç»“æœç»„åˆå¹¶æ˜ å°„åˆ° [1, 10] èŒƒå›´å†… int index = (first - 1) * 3 * 5 + (second - 1) * 5 + (third - 1) + 1; if (index \u003c= 10) return index; else return rand10(); // å¦‚æœç»“æœè¶…å‡ºèŒƒå›´ï¼Œåˆ™é‡æ–°é‡‡æ · } ","date":"2025-03-22","objectID":"/2025/b44918a/:5:0","tags":["æ„é€ "],"title":"æ„é€  RandX()","uri":"/2025/b44918a/"},{"categories":["éšè®°"],"content":"å»ºç«™è¸©å‘è¿‡ç¨‹ ","date":"2025-03-22","objectID":"/2025/b487c0a/:0:0","tags":null,"title":"å»ºç«™è¸©å‘è®°å½•","uri":"/2025/b487c0a/"},{"categories":["éšè®°"],"content":"é›†æˆ latex æ–¹æ³•ä¸€ ","date":"2025-03-22","objectID":"/2025/b487c0a/:1:0","tags":null,"title":"å»ºç«™è¸©å‘è®°å½•","uri":"/2025/b487c0a/"},{"categories":["éšè®°"],"content":"ä¼˜ç§€å‚è€ƒ https://github.com/shuzang/shuzang.github.io ","date":"2025-03-22","objectID":"/2025/b487c0a/:2:0","tags":null,"title":"å»ºç«™è¸©å‘è®°å½•","uri":"/2025/b487c0a/"},{"categories":["éšè®°"],"content":"content ç›®å½•ä½ç½® ç§»åŠ¨åˆ°å·¦è¾¹ï¼šhttps://blog.csdn.net/Xuyiming564445/article/details/122011603 ","date":"2025-03-22","objectID":"/2025/b487c0a/:3:0","tags":null,"title":"å»ºç«™è¸©å‘è®°å½•","uri":"/2025/b487c0a/"},{"categories":["éšè®°"],"content":"è¯„è®ºç³»ç»Ÿ ä½¿ç”¨ giscusï¼Œå°† repo çš„discussion æ¨¡å—ç”¨äºè¯„è®ºã€‚è¯¦æƒ…è§ï¼š http://www.icharm.me/hugo-loveit-using/index.zh_cn.html https://giscus.app/zh-CN ","date":"2025-03-22","objectID":"/2025/b487c0a/:4:0","tags":null,"title":"å»ºç«™è¸©å‘è®°å½•","uri":"/2025/b487c0a/"},{"categories":null,"content":"å…³äºæˆ‘ MLSys å…¥é—¨å°èœé¸¡ ","date":"0001-01-01","objectID":"/about/:1:0","tags":null,"title":"å…³äº","uri":"/about/"}]